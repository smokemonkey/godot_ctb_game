<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTBç³»ç»Ÿæ¼”ç¤º - å›åˆåˆ¶æˆ˜æ–—æ—¶é—´ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">
    <script src="/config.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', 'Simhei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr 350px;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .info-text {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 13px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-log {
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .control-group h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px 0;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input-group label {
            color: #2c3e50;
            font-weight: bold;
            min-width: 80px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .info-text, .scrollable-log {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .info-text::-webkit-scrollbar, .scrollable-log::-webkit-scrollbar {
            width: 6px;
        }

        .info-text::-webkit-scrollbar-track, .scrollable-log::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .info-text::-webkit-scrollbar-thumb, .scrollable-log::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        /* è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡æ ·å¼ */
        .action-order-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 300px;
            padding: 10px 0;
            gap: 8px;
            background: linear-gradient(180deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .action-order-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            border: 3px solid #3498db;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .action-order-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .action-order-avatar.active {
            border-color: #e67e22;
            box-shadow: 0 0 12px rgba(230, 126, 34, 0.6);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .action-order-avatar.predicted {
            border-color: #27ae60;
            box-shadow: 0 0 12px rgba(39, 174, 96, 0.6);
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .action-order-avatar .faction-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .action-order-avatar .time-info {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #7f8c8d;
            white-space: nowrap;
            background: rgba(255,255,255,0.9);
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .action-order-avatar:hover .time-info {
            opacity: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* é˜µè¥é¢œè‰²æ˜ å°„ */
        .faction-shu { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important; }
        .faction-wei { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important; }
        .faction-wu { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important; }
        .faction-qi { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important; }
        .faction-chu { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%) !important; }
        .faction-yan { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%) !important; }
        .faction-han { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%) !important; }
        .faction-zhao { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important; }
        .faction-neutral { background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important; }
    </style>
</head>
<body>
    <div id="app" class="ui container">
        <div class="container">
            <div class="header">
                <h1>ğŸº CTBç³»ç»Ÿæ¼”ç¤º</h1>
                <p>åŸºäºæ˜¥ç§‹æ—¶ä»£çš„å›åˆåˆ¶æˆ˜æ–—æ—¶é—´ç®¡ç†ç³»ç»Ÿ</p>
            </div>

            <div class="content">
                <!-- å·¦ä¾§é¢æ¿ -->
                <div>
                    <div class="panel">
                        <h3>ğŸ“… æ—¶é—´ä¿¡æ¯</h3>
                        <div class="info-text" id="timeInfo">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ‘¥ è§’è‰²ä¿¡æ¯</h3>
                        <div class="info-text" id="characterInfo">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ§­ è¡ŒåŠ¨é¡ºåºé¢„æµ‹</h3>
                        <div class="action-order-bar" id="actionOrderBar">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                ç­‰å¾…åˆå§‹åŒ–...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´é¢æ¿ -->
                <div>
                    <div class="panel">
                        <h3>âš”ï¸ CTBçŠ¶æ€</h3>
                        <div class="info-text" id="ctbStatus">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>â³ è¡ŒåŠ¨é˜Ÿåˆ—</h3>
                        <div class="info-text" id="actionQueue">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ”­ è¡ŒåŠ¨é¢„æµ‹</h3>
                        <div class="info-text" id="predictionBar">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ“œ è¡ŒåŠ¨å†å²</h3>
                        <div class="scrollable-log" id="actionHistory">ç­‰å¾…è¡ŒåŠ¨...</div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="controls">
                    <div class="control-group">
                        <h4>âš™ï¸ ç³»ç»Ÿæ§åˆ¶</h4>
                        <button class="btn success" onclick="initializeCTB()">ğŸš€ åˆå§‹åŒ–CTB</button>
                        <button class="btn" onclick="executeNextAction()">â–¶ï¸ æ‰§è¡Œä¸‹ä¸ªè¡ŒåŠ¨</button>
                        <button class="btn warning" onclick="skipToNext()">â­ï¸ è·³è½¬æ—¶é—´</button>
                        <button class="btn danger" onclick="resetCTB()">ğŸ”„ é‡ç½®ç³»ç»Ÿ</button>
                    </div>

                    <div class="control-group">
                        <h4>ğŸ® æµ‹è¯•åŠŸèƒ½</h4>
                        <button class="btn" onclick="toggleCharacterActive()">ğŸ”„ åˆ‡æ¢è§’è‰²çŠ¶æ€</button>
                        <button class="btn" onclick="addRandomCharacter()">â• æ·»åŠ éšæœºè§’è‰²</button>
                        <button class="btn" onclick="showPredictionDemo()">ğŸ”® é¢„æµ‹æ¼”ç¤º</button>
                        <button class="btn" onclick="runMediumTest()">âš¡ 100äººæµ‹è¯•</button>
                        <button class="btn warning" onclick="runStressTest()">ğŸš€ åˆå§‹åŒ– (å‹æµ‹æ¨¡å¼)</button>
                    </div>

                    <div class="control-group">
                        <h4>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h4>
                        <div style="font-size: 12px; color: #7f8c8d;">
                            <div>ç³»ç»ŸçŠ¶æ€: <span id="systemStatus" style="font-weight: bold;">æœªåˆå§‹åŒ–</span></div>
                            <div>è§’è‰²æ•°é‡: <span id="characterCount">0</span></div>
                            <div>è¡ŒåŠ¨æ€»æ•°: <span id="actionCount">0</span></div>
                            <div id="stressTestResult" style="margin-top: 10px; white-space: pre-wrap; font-weight: bold; color: #27ae60; font-size: 13px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿçš„åç«¯æ•°æ®
        let gameState = {
            timeManager: {
                currentYear: window.gameConfig.EPOCH_START_YEAR,
                currentMonth: 1,
                currentDay: 1,
                currentHour: 0,
                totalHours: 0
            },
            ctbManager: {
                isInitialized: false,
                characters: [],
                events: [], // æ”¹ä¸ºeventsæ•°ç»„ï¼Œå­˜å‚¨æ‰€æœ‰è°ƒåº¦çš„äº‹ä»¶
                actionHistory: [],
                nextEventId: 1
            }
        };

        // æµ‹è¯•è§’è‰²æ•°æ® (å¯¹åº” examples/data/ctb_characters.py ä¸­çš„åŸºç¡€è§’è‰²ç»„)
        const testCharacters = [
            { id: "char_zhang", name: "å¼ ä¸‰", faction: "èœ€å›½", isActive: true },
            { id: "char_li", name: "æå››", faction: "é­å›½", isActive: true },
            { id: "char_wang", name: "ç‹äº”", faction: "å´å›½", isActive: true }
        ];

        // è®¡ç®—ä¸‹æ¬¡è¡ŒåŠ¨æ—¶é—´ï¼ˆæ¨¡æ‹Ÿæ–°çš„éšæœºé—´éš”ç®—æ³•ï¼‰
        function calculateNextActionTime(currentTime, character) {
            // ä½¿ç”¨ä¸‰è§’åˆ†å¸ƒï¼šæœ€å°1å¤©ï¼Œæœ€å¤§180å¤©ï¼Œä¼—æ•°90å¤©
            const minDays = 1;
            const maxDays = 180;
            const modeDays = 90;

            // ç®€åŒ–çš„ä¸‰è§’åˆ†å¸ƒå®ç°
            const u = Math.random();
            let days;
            if (u < 0.5) {
                days = minDays + Math.sqrt(u * 2) * (modeDays - minDays);
            } else {
                days = maxDays - Math.sqrt((1 - u) * 2) * (maxDays - modeDays);
            }

            const hours = Math.floor(days * 24);
            return currentTime + hours;
        }

        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
        function updateAllDisplays() {
            updateTimeDisplay();
            updateCTBStatus();
            updateCharacterInfo();
            updateActionQueue();
            updatePredictionBar();
            updateActionOrderBar();
            updateSystemStatus();
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "å…¬å…ƒå‰" : "å…¬å…ƒ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const timeText = `å½“å‰æ—¶é—´: ${era}${year}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹
çºªå¹´: æ˜¥ç§‹${eraYear}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹
æ€»è®¡å°æ—¶: ${tm.totalHours}
æ€»è®¡å¤©æ•°: ${Math.floor(tm.totalHours / 24)}`;

            document.getElementById('timeInfo').textContent = timeText;
        }

        // æ›´æ–°CTBçŠ¶æ€
        function updateCTBStatus() {
            const ctb = gameState.ctbManager;
            const statusText = `ç³»ç»ŸçŠ¶æ€: ${ctb.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
äº‹ä»¶æ•°é‡: ${ctb.events.length}
æ´»è·ƒè§’è‰²: ${ctb.characters.filter(c => c.isActive).length}/${ctb.characters.length}
é˜Ÿåˆ—é•¿åº¦: ${ctb.actionQueue.length}
å†å²è®°å½•: ${ctb.actionHistory.length}`;

            document.getElementById('ctbStatus').textContent = statusText;
        }

        // æ›´æ–°è§’è‰²ä¿¡æ¯
        function updateCharacterInfo() {
            const characters = gameState.ctbManager.characters;
            let text = `=== è§’è‰²åˆ—è¡¨ (å…± ${characters.length} ä¸ª) ===\n`;
            const displayLimit = 20;

            if (characters.length === 0) {
                text += "æš‚æ— è§’è‰²";
            } else {
                const charactersToShow = characters.slice(0, displayLimit);

                charactersToShow.forEach(char => {
                    const status = char.isActive ? "âœ“" : "âœ—";
                    // æŸ¥æ‰¾è§’è‰²çš„ä¸‹æ¬¡è¡ŒåŠ¨æ—¶é—´
                    const nextEvent = gameState.ctbManager.events.find(e => e.characterId === char.id);
                    let timeText = "æœªè°ƒåº¦";

                    if (nextEvent) {
                        const timeUntil = nextEvent.triggerTime - gameState.timeManager.totalHours;
                        if (timeUntil <= 0) {
                            timeText = "ç«‹å³æ‰§è¡Œ";
                        } else {
                            const days = Math.floor(timeUntil / 24);
                            if (days > 0) {
                                timeText = `${days}å¤©å`;
                            } else {
                                timeText = `${Math.floor(timeUntil)}å°æ—¶å`;
                            }
                        }
                    }

                    text += `${status} ${char.name} (${char.faction})\n`;
                    text += `  ä¸‹æ¬¡è¡ŒåŠ¨: ${timeText}\n`;
                });

                if (characters.length > displayLimit) {
                    text += `\n... (ä»…æ˜¾ç¤ºå‰ ${displayLimit} ä¸ªè§’è‰²)`;
                }
            }

            document.getElementById('characterInfo').textContent = text;
        }

        // æ›´æ–°è¡ŒåŠ¨é˜Ÿåˆ—
        function updateActionQueue() {
            const queue = gameState.ctbManager.actionQueue;
            let text = "=== è¡ŒåŠ¨é˜Ÿåˆ— ===\n";

            if (queue.length === 0) {
                text += "é˜Ÿåˆ—ä¸ºç©º";
            } else {
                queue.slice(0, 8).forEach((action, index) => {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);

                    if (index === 0) {
                        text += `â†’ ${action.characterName}\n`;
                    } else {
                        text += `  ${action.characterName}\n`;
                    }

                    if (timeUntil <= 0) {
                        text += `    ç«‹å³æ‰§è¡Œ\n`;
                    } else if (days > 0) {
                        text += `    ${days}å¤©${hours}å°æ—¶å\n`;
                    } else {
                        text += `    ${hours}å°æ—¶å\n`;
                    }
                });
            }

            document.getElementById('actionQueue').textContent = text;
        }

        // æ›´æ–°é¢„æµ‹æ¡
        function updatePredictionBar() {
            const predictions = predictFutureActions(10); // é¢„æµ‹æœªæ¥10ä¸ªè¡ŒåŠ¨
            let text = "=== æœªæ¥10æ¬¡è¡ŒåŠ¨é¢„æµ‹ ===\n";

            if (predictions.length === 0) {
                text = "æ— æ³•é¢„æµ‹ï¼ˆé˜Ÿåˆ—ä¸ºç©ºæˆ–æœªåˆå§‹åŒ–ï¼‰";
            } else {
                predictions.forEach((action, index) => {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);

                    text += `${String(index + 1).padStart(2, ' ')}. ${action.characterName}\n`;

                    if (timeUntil <= 0) {
                        text += `     ç«‹å³æ‰§è¡Œ\n`;
                    } else if (days > 0) {
                        text += `     å°†åœ¨ ${days}å¤©${hours}å°æ—¶åè¡ŒåŠ¨\n`;
                    } else {
                        text += `     å°†åœ¨ ${hours}å°æ—¶åè¡ŒåŠ¨\n`;
                    }
                });
            }

            document.getElementById('predictionBar').textContent = text;
        }

        // æ›´æ–°è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡
        function updateActionOrderBar(predictedOrder = null) {
            const bar = document.getElementById('actionOrderBar');
            const ctb = gameState.ctbManager;

            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                bar.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">ç­‰å¾…åˆå§‹åŒ–...</div>';
                return;
            }

            // ä½¿ç”¨é¢„æµ‹é¡ºåºæˆ–å½“å‰é¡ºåº
            const order = predictedOrder || ctb.actionQueue;
            bar.innerHTML = '';

            // æ˜¾ç¤ºå‰8ä¸ªè¡ŒåŠ¨
            order.slice(0, 8).forEach((action, index) => {
                const character = ctb.characters.find(c => c.id === action.characterId);
                if (!character) return;

                const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                const days = Math.floor(timeUntil / 24);
                const hours = Math.floor(timeUntil % 24);

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'action-order-avatar';

                // æ·»åŠ é˜µè¥æ ·å¼æˆ–è‡ªå®šä¹‰é¢œè‰²
                if (character.customColor) {
                    // ä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²
                    avatarDiv.style.background = `linear-gradient(135deg, ${character.customColor} 0%, ${darkenColor(character.customColor, 0.2)} 100%)`;
                    avatarDiv.style.color = 'white';
                } else {
                    // ä½¿ç”¨é˜µè¥æ ·å¼
                    const factionClass = getFactionClass(character.faction);
                    if (factionClass) {
                        avatarDiv.classList.add(factionClass);
                    }
                }

                // å½“å‰è¡ŒåŠ¨é«˜äº®
                if (index === 0) {
                    avatarDiv.classList.add('active');
                }

                // é¢„æµ‹çŠ¶æ€
                if (predictedOrder && index < 3) {
                    avatarDiv.classList.add('predicted');
                }

                // å¤´åƒå†…å®¹ï¼ˆä½¿ç”¨åå­—é¦–å­—æ¯ï¼‰
                avatarDiv.textContent = character.name[0];

                // é˜µè¥å¾½ç« 
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'faction-badge';
                badgeDiv.textContent = character.faction[0];
                badgeDiv.style.backgroundColor = character.customColor || getFactionColor(character.faction);
                avatarDiv.appendChild(badgeDiv);

                // æ—¶é—´ä¿¡æ¯
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-info';
                if (timeUntil <= 0) {
                    timeDiv.textContent = 'ç«‹å³';
                } else if (days > 0) {
                    timeDiv.textContent = `${days}å¤©${hours}æ—¶`;
                } else {
                    timeDiv.textContent = `${hours}æ—¶`;
                }
                avatarDiv.appendChild(timeDiv);

                // ç‚¹å‡»äº‹ä»¶ï¼ˆå¯ä»¥æ‰©å±•ä¸ºæŠ€èƒ½é€‰æ‹©ç­‰ï¼‰
                avatarDiv.onclick = function() {
                    showCharacterDetails(character, action);
                };

                bar.appendChild(avatarDiv);
            });

            // å¦‚æœè¡ŒåŠ¨æ•°é‡è¶…è¿‡8ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º
            if (order.length > 8) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#7f8c8d';
                moreDiv.style.fontSize = '12px';
                moreDiv.style.marginTop = '10px';
                moreDiv.textContent = `è¿˜æœ‰ ${order.length - 8} ä¸ªè¡ŒåŠ¨...`;
                bar.appendChild(moreDiv);
            }
        }

        // è·å–é˜µè¥CSSç±»å
        function getFactionClass(faction) {
            const factionMap = {
                'èœ€å›½': 'faction-shu',
                'é­å›½': 'faction-wei',
                'å´å›½': 'faction-wu',
                'é½å›½': 'faction-qi',
                'æ¥šå›½': 'faction-chu',
                'ç‡•å›½': 'faction-yan',
                'éŸ©å›½': 'faction-han',
                'èµµå›½': 'faction-zhao',
                'ä¸­ç«‹': 'faction-neutral'
            };
            return factionMap[faction] || '';
        }

        // è·å–é˜µè¥é¢œè‰²
        function getFactionColor(faction) {
            const colorMap = {
                'èœ€å›½': '#e74c3c',
                'é­å›½': '#3498db',
                'å´å›½': '#f39c12',
                'é½å›½': '#9b59b6',
                'æ¥šå›½': '#27ae60',
                'ç‡•å›½': '#1abc9c',
                'éŸ©å›½': '#34495e',
                'èµµå›½': '#e67e22',
                'ä¸­ç«‹': '#95a5a6'
            };
            return colorMap[faction] || '#95a5a6';
        }

        // é¢œè‰²å˜æš—è¾…åŠ©å‡½æ•°
        function darkenColor(color, factor) {
            // ç®€å•çš„é¢œè‰²å˜æš—ç®—æ³•
            const hex = color.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) * (1 - factor));
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) * (1 - factor));
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) * (1 - factor));
            return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºè§’è‰²è¯¦æƒ…ï¼ˆå¯æ‰©å±•ä¸ºæŠ€èƒ½é€‰æ‹©ç­‰ï¼‰
        function showCharacterDetails(character, action) {
            const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
            const days = Math.floor(timeUntil / 24);
            const hours = Math.floor(timeUntil % 24);

            let timeText = '';
            if (timeUntil <= 0) {
                timeText = 'ç«‹å³æ‰§è¡Œ';
            } else if (days > 0) {
                timeText = `${days}å¤©${hours}å°æ—¶å`;
            } else {
                timeText = `${hours}å°æ—¶å`;
            }

            addActionLog(`è§’è‰²è¯¦æƒ…: ${character.name} (${character.faction}) - ${timeText}è¡ŒåŠ¨`);
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            const ctb = gameState.ctbManager;
            document.getElementById('systemStatus').textContent = ctb.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            document.getElementById('characterCount').textContent = ctb.characters.length;
            document.getElementById('actionCount').textContent = ctb.actionHistory.length;
        }

        // æ·»åŠ è¡ŒåŠ¨å†å²è®°å½•
        function addActionLog(message) {
            const historyDiv = document.getElementById('actionHistory');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

            historyDiv.appendChild(logEntry);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // ä¿æŒæœ€æ–°50æ¡è®°å½•
            while (historyDiv.children.length > 50) {
                historyDiv.removeChild(historyDiv.firstChild);
            }
        }

        // é¢„æµ‹æœªæ¥è¡ŒåŠ¨
        function predictFutureActions(count) {
            const ctb = gameState.ctbManager;
            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                return [];
            }

            // ä½¿ç”¨æ·±æ‹·è´åˆ›å»ºæ¨¡æ‹Ÿç¯å¢ƒ
            let simQueue = JSON.parse(JSON.stringify(ctb.actionQueue));

            const predictions = [];

            for (let i = 0; i < count; i++) {
                if (simQueue.length === 0) break;

                // è·å–ä¸‹ä¸€ä¸ªè¡ŒåŠ¨ (JSä¸­shift()ä»æ•°ç»„å¤´éƒ¨å–å‡º)
                const nextAction = simQueue.shift();
                predictions.push(nextAction);

                // å®‰æ’è¯¥è§’è‰²çš„ä¸‹ä¸€æ¬¡è¡ŒåŠ¨
                const character = ctb.characters.find(c => c.id === nextAction.characterId);
                if (character && character.isActive) {
                    // ä½¿ç”¨æ–°çš„éšæœºé—´éš”ç®—æ³•
                    const nextTriggerTime = calculateNextActionTime(nextAction.triggerTime, character);

                    simQueue.push({
                        id: -1, // æ¨¡æ‹Ÿè¡ŒåŠ¨ID
                        characterId: character.id,
                        characterName: character.name,
                        triggerTime: nextTriggerTime,
                        actionType: 'attack'
                    });

                    // ä¿æŒæ¨¡æ‹Ÿé˜Ÿåˆ—æ’åº
                    simQueue.sort((a, b) => a.triggerTime - b.triggerTime);
                }
            }

            return predictions;
        }

        // CTBç³»ç»Ÿæ§åˆ¶å‡½æ•°
        function initializeCTB() {
            // 1. å…ˆæ·»åŠ è§’è‰²ï¼ˆæ¨¡æ‹ŸçœŸå®ç³»ç»Ÿçš„add_characterï¼‰
            gameState.ctbManager.characters = [];
            testCharacters.forEach(char => {
                gameState.ctbManager.characters.push({...char});
            });

            // 2. ç„¶ååˆå§‹åŒ–ç³»ç»Ÿï¼ˆæ¨¡æ‹ŸçœŸå®ç³»ç»Ÿçš„initialize_ctbï¼‰
            if (gameState.ctbManager.characters.length === 0) {
                addActionLog("é”™è¯¯ï¼šæ²¡æœ‰è§’è‰²ï¼Œæ— æ³•åˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            gameState.ctbManager.events = [];
            gameState.ctbManager.actionQueue = [];

            // ä¸ºæ¯ä¸ªæ´»è·ƒè§’è‰²å®‰æ’åˆå§‹è¡ŒåŠ¨æ—¶é—´
            gameState.ctbManager.characters.forEach(char => {
                if (char.isActive) {
                    // ä½¿ç”¨æ–°çš„éšæœºé—´éš”ç®—æ³•è®¡ç®—åˆå§‹è¡ŒåŠ¨æ—¶é—´
                    const initialDelayHours = Math.floor(Math.random() * 24 * 30) + 1; // 1-30å¤©éšæœº
                    const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                    const event = {
                        id: gameState.ctbManager.nextEventId++,
                        characterId: char.id,
                        characterName: char.name,
                        triggerTime: triggerTime,
                        actionType: 'attack'
                    };

                    // æ·»åŠ åˆ°äº‹ä»¶åˆ—è¡¨å’Œè¡ŒåŠ¨é˜Ÿåˆ—
                    gameState.ctbManager.events.push(event);
                    gameState.ctbManager.actionQueue.push(event);
                }
            });

            // æŒ‰è§¦å‘æ—¶é—´æ’åº
            gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

            // è®¾ç½®ç³»ç»Ÿä¸ºå·²åˆå§‹åŒ–çŠ¶æ€
            gameState.ctbManager.isInitialized = true;

            addActionLog(`CTBç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œæ·»åŠ äº† ${gameState.ctbManager.characters.length} ä¸ªè§’è‰²`);
            updateAllDisplays();
        }

        function executeNextAction() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const action = gameState.ctbManager.actionQueue.shift();
            if (!action) {
                addActionLog("æ²¡æœ‰å¾…æ‰§è¡Œçš„è¡ŒåŠ¨");
                return;
            }

            // ä»eventsæ•°ç»„ä¸­ç§»é™¤å·²æ‰§è¡Œçš„äº‹ä»¶
            const eventIndex = gameState.ctbManager.events.findIndex(e => e.id === action.id);
            if (eventIndex !== -1) {
                gameState.ctbManager.events.splice(eventIndex, 1);
            }

            // æ¨è¿›æ—¶é—´åˆ°è¡ŒåŠ¨æ—¶é—´
            gameState.timeManager.totalHours = action.triggerTime;
            updateTimeFromTotalHours();

            // è®°å½•è¡ŒåŠ¨
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "å…¬å…ƒå‰" : "å…¬å…ƒ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const logMessage = `æ˜¥ç§‹${eraYear}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹ (${era}${year}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹) - ${action.characterName} è¡ŒåŠ¨`;
            addActionLog(logMessage);

            // æ·»åŠ åˆ°å†å²
            gameState.ctbManager.actionHistory.push({
                ...action,
                executedTime: action.triggerTime,
                timestamp: Date.now()
            });

            // ä¸ºè¯¥è§’è‰²å®‰æ’ä¸‹æ¬¡è¡ŒåŠ¨
            const character = gameState.ctbManager.characters.find(c => c.id === action.characterId);
            if (character && character.isActive) {
                // ä½¿ç”¨æ–°çš„éšæœºé—´éš”ç®—æ³•
                const nextTriggerTime = calculateNextActionTime(action.triggerTime, character);

                const nextEvent = {
                    id: gameState.ctbManager.nextEventId++,
                    characterId: character.id,
                    characterName: character.name,
                    triggerTime: nextTriggerTime,
                    actionType: 'attack'
                };

                gameState.ctbManager.events.push(nextEvent);
                gameState.ctbManager.actionQueue.push(nextEvent);

                // é‡æ–°æ’åºé˜Ÿåˆ—
                gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);
            }

            updateAllDisplays();
        }

        function skipToNext() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const nextAction = gameState.ctbManager.actionQueue[0];
            if (!nextAction) {
                addActionLog("æ²¡æœ‰å¾…æ‰§è¡Œçš„è¡ŒåŠ¨");
                return;
            }

            // ç›´æ¥è·³è½¬æ—¶é—´
            gameState.timeManager.totalHours = nextAction.triggerTime;
            updateTimeFromTotalHours();

            addActionLog(`æ—¶é—´å·²è·³è½¬åˆ° ${nextAction.characterName} çš„è¡ŒåŠ¨æ—¶é—´`);
            updateAllDisplays();
        }

        function resetCTB(silent = false) {
            gameState.ctbManager = {
                isInitialized: false,
                characters: [],
                events: [],
                actionQueue: [],
                actionHistory: [],
                nextEventId: 1
            };

            if (!silent) {
                addActionLog("CTBç³»ç»Ÿå·²é‡ç½®");
            }
            // Clear stress test results on reset
            const resultDiv = document.getElementById('stressTestResult');
            if (resultDiv) resultDiv.textContent = "";

            updateAllDisplays();
        }

        function toggleCharacterActive() {
            if (gameState.ctbManager.characters.length > 0) {
                const char = gameState.ctbManager.characters[0];
                char.isActive = !char.isActive;
                const status = char.isActive ? "æ¿€æ´»" : "åœç”¨";
                addActionLog(`${char.name} å·²${status}`);
                updateAllDisplays();
            }
        }

        function addRandomCharacter() {
            const names = ["èµµå…­", "å­™ä¸ƒ", "å‘¨å…«", "å´ä¹", "éƒ‘å"];
            const factions = ["é½å›½", "æ¥šå›½", "ç‡•å›½", "éŸ©å›½", "èµµå›½"];

            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomFaction = factions[Math.floor(Math.random() * factions.length)];

            const newChar = {
                id: `char_${Date.now()}`,
                name: randomName,
                faction: randomFaction,
                isActive: true
            };

            gameState.ctbManager.characters.push(newChar);
            addActionLog(`æ·»åŠ è§’è‰²: ${randomName}(${randomFaction})`);
            updateAllDisplays();
        }

        // é¢„æµ‹æ¼”ç¤ºåŠŸèƒ½
        function showPredictionDemo() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const ctb = gameState.ctbManager;
            if (ctb.actionQueue.length < 2) {
                addActionLog("éœ€è¦è‡³å°‘2ä¸ªè¡ŒåŠ¨æ‰èƒ½æ¼”ç¤ºé¢„æµ‹æ•ˆæœ");
                return;
            }

            // åˆ›å»ºé¢„æµ‹é¡ºåºï¼ˆæ¨¡æ‹Ÿç¬¬ä¸€ä¸ªè§’è‰²è¡ŒåŠ¨åï¼Œç¬¬äºŒä¸ªè§’è‰²æå‰è¡ŒåŠ¨ï¼‰
            const predictedOrder = [...ctb.actionQueue];

            // æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªè§’è‰²è¡ŒåŠ¨åï¼Œç¬¬äºŒä¸ªè§’è‰²çš„è¡ŒåŠ¨æ—¶é—´æå‰
            if (predictedOrder.length >= 2) {
                const firstAction = predictedOrder[0];
                const secondAction = predictedOrder[1];

                // æ¨¡æ‹Ÿç¬¬äºŒä¸ªè§’è‰²å› ä¸ºæŸç§æŠ€èƒ½æˆ–æ•ˆæœæå‰è¡ŒåŠ¨
                const timeAdvance = Math.floor(Math.random() * 24) + 1; // æå‰1-24å°æ—¶
                secondAction.triggerTime = firstAction.triggerTime + timeAdvance;

                // é‡æ–°æ’åº
                predictedOrder.sort((a, b) => a.triggerTime - b.triggerTime);

                addActionLog(`ğŸ”® é¢„æµ‹æ¼”ç¤º: å‡è®¾${firstAction.characterName}è¡ŒåŠ¨åï¼Œ${secondAction.characterName}æå‰${timeAdvance}å°æ—¶è¡ŒåŠ¨`);

                // æ˜¾ç¤ºé¢„æµ‹æ•ˆæœ
                updateActionOrderBar(predictedOrder);

                // 3ç§’åæ¢å¤åŸå§‹æ˜¾ç¤º
                setTimeout(() => {
                    updateActionOrderBar();
                    addActionLog("é¢„æµ‹æ¼”ç¤ºç»“æŸï¼Œæ¢å¤åŸå§‹é¡ºåº");
                }, 3000);
            }
        }

        // ä»æ€»å°æ—¶æ•°æ›´æ–°æ—¥æœŸæ—¶é—´
        function updateTimeFromTotalHours() {
            const totalHours = gameState.timeManager.totalHours;
            const totalDays = Math.floor(totalHours / 24);
            const hours = totalHours % 24;

            // ç®€åŒ–çš„æ—¥æœŸè®¡ç®—ï¼ˆ360å¤©/å¹´ï¼Œ30å¤©/æœˆï¼‰
            const startYear = window.gameConfig.EPOCH_START_YEAR;
            const years = Math.floor(totalDays / 360);
            const remainingDays = totalDays % 360;
            const months = Math.floor(remainingDays / 30);
            const days = remainingDays % 30;

            gameState.timeManager.currentYear = startYear + years;
            gameState.timeManager.currentMonth = months + 1;
            gameState.timeManager.currentDay = days + 1;
            gameState.timeManager.currentHour = hours;
        }

        // 100äººæµ‹è¯•æ¨¡å¼
        function runMediumTest() {
            addActionLog("âš¡ å¼€å§‹100äººæµ‹è¯•åˆå§‹åŒ–...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "åˆå§‹åŒ–ä¸­...";

            setTimeout(() => {
                try {
                    // 1. é‡ç½®ç³»ç»ŸçŠ¶æ€
                    resetCTB(true);

                    // 2. è®¾ç½®å‚æ•°
                    const characterCount = 100;
                    const averageIntervalDays = 30; // æ›´çŸ­çš„é—´éš”ï¼Œä¾¿äºè§‚å¯Ÿ
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ç”Ÿæˆéšæœºåå­—å’Œé¢œè‰²
                    const surnames = ['å¼ ', 'æ', 'ç‹', 'èµµ', 'é™ˆ', 'åˆ˜', 'æ¨', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—', 'æ¢', 'å®‹', 'éƒ‘', 'è°¢', 'éŸ©', 'å”', 'å†¯', 'äº', 'è‘£', 'è§', 'ç¨‹', 'æ›¹', 'è¢', 'é‚“', 'è®¸', 'å‚…', 'æ²ˆ', 'æ›¾', 'å½­', 'å•', 'è‹', 'å¢', 'è’‹', 'è”¡', 'è´¾', 'ä¸', 'é­', 'è–›', 'å¶', 'é˜', 'ä½™', 'æ½˜', 'æœ', 'æˆ´', 'å¤', 'é’Ÿ', 'æ±ª', 'ç”°', 'ä»»', 'å§œ', 'èŒƒ', 'æ–¹', 'çŸ³', 'å§š', 'è°­', 'å»–', 'é‚¹', 'ç†Š', 'é‡‘', 'é™†', 'éƒ', 'å­”', 'ç™½', 'å´”', 'åº·', 'æ¯›', 'é‚±', 'ç§¦', 'æ±Ÿ', 'å²', 'é¡¾', 'ä¾¯', 'é‚µ', 'å­Ÿ', 'é¾™', 'ä¸‡', 'æ®µ', 'é›·', 'é’±', 'æ±¤', 'å°¹', 'é»', 'æ˜“', 'å¸¸', 'æ­¦', 'ä¹”', 'è´º', 'èµ–', 'é¾š', 'æ–‡'];
                    const givenNames = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°', 'éœ', 'å¹³', 'åˆš', 'æ¡‚è‹±', 'å»ºå', 'å»ºå›½', 'å»ºå†›', 'å»ºå¹³', 'å»ºå', 'å»ºæ˜', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºå‹‡', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»', 'å»ºå‹‡', 'å»ºåˆš', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»'];
                    const factions = ['èœ€å›½', 'é­å›½', 'å´å›½', 'é½å›½', 'æ¥šå›½', 'ç‡•å›½', 'éŸ©å›½', 'èµµå›½', 'ç§¦å›½', 'æ™‹å›½', 'å®‹å›½', 'å«å›½', 'éƒ‘å›½', 'é²å›½', 'è¶Šå›½', 'ä¸­å±±å›½', 'æ»•å›½', 'è–›å›½', 'è’å›½', 'é‚¾å›½', 'éƒ¯å›½', 'å°é‚¾å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½'];

                    // é¢„ç”Ÿæˆéšæœºé¢œè‰²æ± 
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ç”Ÿæˆè§’è‰²å¹¶è®¡ç®—ç†è®ºå¹³å‡å€¼
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ç”Ÿæˆéšæœºåå­—
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // éšæœºé˜µè¥
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // åˆ†é…å›ºå®šéšæœºé¢œè‰²ï¼ˆåŸºäºè§’è‰²IDç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²å±æ€§
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. å®‰æ’é¦–æ¬¡è¡ŒåŠ¨
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // é¦–æ¬¡è¡ŒåŠ¨æ—¶é—´åœ¨ (0, intervalHours] åŒºé—´å†…éšæœºåˆ†å¸ƒ
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextEventId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. æ’åºè¡ŒåŠ¨é˜Ÿåˆ—
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. æ˜¾ç¤ºç†è®ºè®¡ç®—ç»“æœ
                    const resultText = `--- 100äººæµ‹è¯•ç»“æœ ---\nè§’è‰²æ•°é‡: ${characterCount}\nç›®æ ‡è¡ŒåŠ¨é—´éš”: ${averageIntervalDays} å¤©\nç†è®ºå¹³å‡æ¯æ—¥è¡ŒåŠ¨: ${totalActionsPerDay.toFixed(2)} äºº\n\nğŸ’¡ é€‚åˆæµ‹è¯•è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡æ•ˆæœ`;
                    resultDiv.textContent = resultText;

                    addActionLog(`âœ… 100äººæµ‹è¯•åˆå§‹åŒ–å®Œæˆï¼Œå·²ç”Ÿæˆ ${characterCount} ä¸ªè§’è‰²ã€‚`);

                    // 8. æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    updateAllDisplays();

                } catch (e) {
                    console.error("100äººæµ‹è¯•åˆå§‹åŒ–å‡ºé”™:", e);
                    resultDiv.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
                    addActionLog("âŒ 100äººæµ‹è¯•åˆå§‹åŒ–å¤±è´¥ã€‚");
                }
            }, 50);
        }

        function runStressTest() {
            addActionLog("ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯•åˆå§‹åŒ–...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "åˆå§‹åŒ–ä¸­...";

            setTimeout(() => {
                try {
                    // 1. é‡ç½®ç³»ç»ŸçŠ¶æ€
                    resetCTB(true);

                    // 2. è®¾ç½®å‚æ•°
                    const characterCount = 10000;
                    const averageIntervalDays = 90;
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ç”Ÿæˆéšæœºåå­—å’Œé¢œè‰²
                    const surnames = ['å¼ ', 'æ', 'ç‹', 'èµµ', 'é™ˆ', 'åˆ˜', 'æ¨', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—', 'æ¢', 'å®‹', 'éƒ‘', 'è°¢', 'éŸ©', 'å”', 'å†¯', 'äº', 'è‘£', 'è§', 'ç¨‹', 'æ›¹', 'è¢', 'é‚“', 'è®¸', 'å‚…', 'æ²ˆ', 'æ›¾', 'å½­', 'å•', 'è‹', 'å¢', 'è’‹', 'è”¡', 'è´¾', 'ä¸', 'é­', 'è–›', 'å¶', 'é˜', 'ä½™', 'æ½˜', 'æœ', 'æˆ´', 'å¤', 'é’Ÿ', 'æ±ª', 'ç”°', 'ä»»', 'å§œ', 'èŒƒ', 'æ–¹', 'çŸ³', 'å§š', 'è°­', 'å»–', 'é‚¹', 'ç†Š', 'é‡‘', 'é™†', 'éƒ', 'å­”', 'ç™½', 'å´”', 'åº·', 'æ¯›', 'é‚±', 'ç§¦', 'æ±Ÿ', 'å²', 'é¡¾', 'ä¾¯', 'é‚µ', 'å­Ÿ', 'é¾™', 'ä¸‡', 'æ®µ', 'é›·', 'é’±', 'æ±¤', 'å°¹', 'é»', 'æ˜“', 'å¸¸', 'æ­¦', 'ä¹”', 'è´º', 'èµ–', 'é¾š', 'æ–‡'];
                    const givenNames = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°', 'éœ', 'å¹³', 'åˆš', 'æ¡‚è‹±', 'å»ºå', 'å»ºå›½', 'å»ºå†›', 'å»ºå¹³', 'å»ºå', 'å»ºæ˜', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºå‹‡', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»', 'å»ºå‹‡', 'å»ºåˆš', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»'];
                    const factions = ['èœ€å›½', 'é­å›½', 'å´å›½', 'é½å›½', 'æ¥šå›½', 'ç‡•å›½', 'éŸ©å›½', 'èµµå›½', 'ç§¦å›½', 'æ™‹å›½', 'å®‹å›½', 'å«å›½', 'éƒ‘å›½', 'é²å›½', 'è¶Šå›½', 'ä¸­å±±å›½', 'æ»•å›½', 'è–›å›½', 'è’å›½', 'é‚¾å›½', 'éƒ¯å›½', 'å°é‚¾å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½'];

                    // é¢„ç”Ÿæˆéšæœºé¢œè‰²æ± 
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ç”Ÿæˆè§’è‰²å¹¶è®¡ç®—ç†è®ºå¹³å‡å€¼
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ç”Ÿæˆéšæœºåå­—
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // éšæœºé˜µè¥
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // åˆ†é…å›ºå®šéšæœºé¢œè‰²ï¼ˆåŸºäºè§’è‰²IDç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²å±æ€§
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. å®‰æ’é¦–æ¬¡è¡ŒåŠ¨
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // é¦–æ¬¡è¡ŒåŠ¨æ—¶é—´åœ¨ (0, intervalHours] åŒºé—´å†…éšæœºåˆ†å¸ƒ
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextEventId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. æ’åºè¡ŒåŠ¨é˜Ÿåˆ—
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. æ˜¾ç¤ºç†è®ºè®¡ç®—ç»“æœ
                    const resultText = `--- å‹åŠ›æµ‹è¯•ç»“æœ ---\nè§’è‰²æ•°é‡: ${characterCount}\nç›®æ ‡è¡ŒåŠ¨é—´éš”: ${averageIntervalDays} å¤©\nç†è®ºå¹³å‡æ¯æ—¥è¡ŒåŠ¨: ${totalActionsPerDay.toFixed(2)} äºº`;
                    resultDiv.textContent = resultText;

                    addActionLog(`âœ… å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å®Œæˆï¼Œå·²ç”Ÿæˆ ${characterCount} ä¸ªè§’è‰²ã€‚`);

                    // 8. æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    updateAllDisplays();

                } catch (e) {
                    console.error("å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å‡ºé”™:", e);
                    resultDiv.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
                    addActionLog("âŒ å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å¤±è´¥ã€‚");
                }
            }, 50);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDisplays();
            addActionLog("ç³»ç»Ÿå¯åŠ¨å®Œæˆ");
            addActionLog("ğŸ’¡ æç¤ºï¼šç‚¹å‡»'åˆå§‹åŒ–CTB'å°†æ·»åŠ è§’è‰²å¹¶å®‰æ’åˆå§‹è¡ŒåŠ¨æ—¶é—´");
            addActionLog("   åˆå§‹åŒ–åï¼Œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªè§’è‰²è®¡ç®—ç¬¬ä¸€æ¬¡è¡ŒåŠ¨çš„æ—¶é—´");
        });
    </script>
</body>
</html>