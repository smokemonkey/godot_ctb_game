<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTBç³»ç»Ÿæ¼”ç¤º - å›åˆåˆ¶æˆ˜æ–—æ—¶é—´ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">
    <script src="/config.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', 'Simhei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr 350px;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .info-text {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 13px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-log {
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .control-group h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px 0;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input-group label {
            color: #2c3e50;
            font-weight: bold;
            min-width: 80px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .info-text, .scrollable-log {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .info-text::-webkit-scrollbar, .scrollable-log::-webkit-scrollbar {
            width: 6px;
        }

        .info-text::-webkit-scrollbar-track, .scrollable-log::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .info-text::-webkit-scrollbar-thumb, .scrollable-log::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        /* è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡æ ·å¼ */
        .action-order-bar {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 500px; /* åŠ é•¿é¢„æµ‹æ  */
            padding: 10px 0;
            gap: 8px;
            background: linear-gradient(180deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .action-order-avatar {
            position: absolute;
            width: 120px;
            height: 40px;
            border-radius: 6px;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            border: 2px solid #3498db;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            left: 50%;
            transform: translateX(-50%);
        }

        .action-order-avatar:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .action-order-avatar.active {
            border-color: #e67e22;
            box-shadow: 0 0 12px rgba(230, 126, 34, 0.6);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .action-order-avatar.predicted {
            border-color: #27ae60;
            box-shadow: 0 0 12px rgba(39, 174, 96, 0.6);
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        /* å¼•åŠ›åæ ‡åŠ¨ç”»ç³»ç»Ÿ */
        .action-order-avatar.gravity-moving {
            transition: top 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* åˆ†å±‚åŠ¨ç”»ï¼šå‰æ’å¿«åæ’æ…¢ */
        .action-order-avatar.gravity-fast {
            transition: top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .action-order-avatar.gravity-medium {
            transition: top 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .action-order-avatar.gravity-slow {
            transition: top 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* ç§»åŠ¨åŠ¨ç”» */
        .action-order-avatar.moving {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ç¬ç§»åŠ¨ç”» */
        .action-order-avatar.teleporting {
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* ä¸Šæµ®åŠ¨ç”» */
        .action-order-avatar.float-up {
            transition: top 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ¶ˆå¤±åŠ¨ç”» */
        .action-order-avatar.fade-out {
            transition: opacity 0.3s ease-out;
            opacity: 0;
        }

        .action-order-avatar .faction-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .action-order-avatar .time-info {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #7f8c8d;
            white-space: nowrap;
            background: rgba(255,255,255,0.9);
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .action-order-avatar:hover .time-info {
            opacity: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* æŠ€èƒ½é¢„æµ‹åŠ¨ç”»æ•ˆæœ */
        @keyframes float-up {
            0% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0); }
        }

        @keyframes float-down {
            0% { transform: translateY(0); }
            50% { transform: translateY(8px); }
            100% { transform: translateY(0); }
        }

        @keyframes breathing {
            0% {
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
                transform: scale(1);
            }
        }

        @keyframes fade-in-out {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        @keyframes skill-applied {
            0% {
                transform: scale(1);
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
            }
            25% {
                transform: scale(1.2);
                box-shadow: 0 0 25px rgba(231, 76, 60, 0.9);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
            }
        }

        /* å»¶åè§’è‰²æ ·å¼ */
        .action-order-avatar.delayed {
            animation: breathing 2s infinite, float-up 3s ease-in-out infinite;
            border-color: #e74c3c !important;
            box-shadow: 0 0 12px rgba(231, 76, 60, 0.6) !important;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            color: white !important;
        }

        /* é¢„æµ‹æ¨¡å¼ä¸‹çš„å…¶ä»–è§’è‰²è½»å¾®ä¸‹æ²‰ */
        .action-order-avatar.prediction-mode {
            animation: float-down 3s ease-in-out infinite;
            opacity: 0.8;
        }

        /* é¢„æµ‹æç¤ºåŠ¨ç”» */
        .prediction-hint {
            animation: fade-in-out 2s ease-in-out infinite;
        }

        /* æŠ€èƒ½åº”ç”¨æˆåŠŸåŠ¨ç”» */
        .action-order-avatar.skill-applied {
            animation: skill-applied 1s ease-in-out;
        }

        /* é˜µè¥é¢œè‰²æ˜ å°„ */
        .faction-shu { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important; }
        .faction-wei { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important; }
        .faction-wu { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important; }
        .faction-qi { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important; }
        .faction-chu { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%) !important; }
        .faction-yan { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%) !important; }
        .faction-han { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%) !important; }
        .faction-zhao { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important; }
        .faction-neutral { background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important; }
    </style>
</head>
<body>
    <div id="app" class="ui container">
        <div class="container">
            <div class="header">
                <h1>ğŸº CTBç³»ç»Ÿæ¼”ç¤º</h1>
                <p>åŸºäºæ˜¥ç§‹æ—¶ä»£çš„å›åˆåˆ¶æˆ˜æ–—æ—¶é—´ç®¡ç†ç³»ç»Ÿ</p>
            </div>

            <div class="content">
                <!-- å·¦ä¾§é¢æ¿ -->
                <div>
                    <div class="panel">
                        <h3>ğŸ“… æ—¶é—´ä¿¡æ¯</h3>
                        <div class="info-text" id="timeInfo">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ‘¥ è§’è‰²ä¿¡æ¯</h3>
                        <div class="info-text" id="characterInfo">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ§­ è¡ŒåŠ¨é¡ºåºé¢„æµ‹</h3>
                        <div class="action-order-bar" id="actionOrderBar">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                ç­‰å¾…åˆå§‹åŒ–...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´é¢æ¿ -->
                <div>
                    <div class="panel">
                        <h3>âš”ï¸ CTBçŠ¶æ€</h3>
                        <div class="info-text" id="ctbStatus">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>â³ è¡ŒåŠ¨é˜Ÿåˆ—</h3>
                        <div class="info-text" id="actionQueue">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ”­ è¡ŒåŠ¨é¢„æµ‹</h3>
                        <div class="info-text" id="predictionBar">ç­‰å¾…åˆå§‹åŒ–...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>ğŸ“œ è¡ŒåŠ¨å†å²</h3>
                        <div class="scrollable-log" id="actionHistory">ç­‰å¾…è¡ŒåŠ¨...</div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="controls">
                    <div class="control-group">
                        <h4>âš™ï¸ ç³»ç»Ÿæ§åˆ¶</h4>
                        <button class="btn success" onclick="initializeCTB()">ğŸš€ åˆå§‹åŒ–CTB</button>
                        <button class="btn" onclick="executeNextAction()">â–¶ï¸ æ‰§è¡Œä¸‹ä¸ªè¡ŒåŠ¨</button>
                        <button class="btn warning" onclick="skipToNext()">â­ï¸ è·³è½¬æ—¶é—´</button>
                        <button class="btn danger" onclick="resetCTB()">ğŸ”„ é‡ç½®ç³»ç»Ÿ</button>
                    </div>

                    <div class="control-group">
                        <h4>ğŸ›ï¸ å‚æ•°è°ƒæ•´</h4>
                        <div class="input-group">
                            <label>åŸºç¡€å› å­:</label>
                            <input type="number" id="factorInput" value="100" min="1" max="1000">
                            <button class="btn" onclick="changeBaseFactor()" style="width: auto; margin: 0;">è®¾ç½®</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>ğŸ® æµ‹è¯•åŠŸèƒ½</h4>
                        <button class="btn" onclick="toggleCharacterActive()">ğŸ”„ åˆ‡æ¢è§’è‰²çŠ¶æ€</button>
                        <button class="btn" onclick="addRandomCharacter()">â• æ·»åŠ éšæœºè§’è‰²</button>
                        <button class="btn" onclick="showPredictionDemo()">ğŸ”® é¢„æµ‹æ¼”ç¤º</button>
                        <button class="btn" onclick="runMediumTest()">âš¡ 100äººæµ‹è¯•</button>
                        <button class="btn warning" onclick="runStressTest()">ğŸš€ åˆå§‹åŒ– (å‹æµ‹æ¨¡å¼)</button>
                        <button class="btn" onclick="testGravityAnimation()">ğŸ¯ æµ‹è¯•å¼•åŠ›åŠ¨ç”»</button>
                    </div>

                    <div class="control-group">
                        <h4>âš¡ æŠ€èƒ½ç³»ç»Ÿ</h4>
                        <div class="input-group">
                            <label>ç›®æ ‡è§’è‰²:</label>
                            <select id="skillTargetSelect" style="flex: 1; padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 4px; font-size: 14px;">
                                <option value="">é€‰æ‹©è§’è‰²...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>å»¶åå°æ—¶:</label>
                            <input type="number" id="delayHoursInput" value="5" min="1" max="100" style="flex: 1;">
                        </div>
                        <button class="btn" onclick="predictSkillEffect()">ğŸ”® é¢„æµ‹æ•ˆæœ</button>
                        <button class="btn success" onclick="applySkillEffect()">âœ¨ åº”ç”¨æŠ€èƒ½</button>
                        <button class="btn warning" onclick="clearPrediction()">ğŸ”„ æ¸…é™¤é¢„æµ‹</button>
                    </div>

                    <div class="control-group">
                        <h4>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h4>
                        <div style="font-size: 12px; color: #7f8c8d;">
                            <div>ç³»ç»ŸçŠ¶æ€: <span id="systemStatus" style="font-weight: bold;">æœªåˆå§‹åŒ–</span></div>
                            <div>è§’è‰²æ•°é‡: <span id="characterCount">0</span></div>
                            <div>è¡ŒåŠ¨æ€»æ•°: <span id="actionCount">0</span></div>
                            <div id="stressTestResult" style="margin-top: 10px; white-space: pre-wrap; font-weight: bold; color: #27ae60; font-size: 13px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿçš„åç«¯æ•°æ®
        let gameState = {
            timeManager: {
                currentYear: window.gameConfig.EPOCH_START_YEAR,
                currentMonth: 1,
                currentDay: 1,
                currentHour: 0,
                totalHours: 0
            },
            ctbManager: {
                isInitialized: false,
                baseFactor: 100,
                characters: [],
                actionQueue: [],
                actionHistory: [],
                nextActionId: 1
            }
        };

        // æµ‹è¯•è§’è‰²æ•°æ® (å¯¹åº” examples/data/ctb_characters.py ä¸­çš„åŸºç¡€è§’è‰²ç»„)
        const testCharacters = [
            { id: 1, name: "å¼ ä¸‰", faction: "èœ€å›½", speed: 5, isActive: true },
            { id: 2, name: "æå››", faction: "é­å›½", speed: 7, isActive: true },
            { id: 3, name: "ç‹äº”", faction: "å´å›½", speed: 10, isActive: true }
        ];

        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
        function updateAllDisplays() {
            updateTimeDisplay();
            updateCTBStatus();
            updateCharacterInfo();
            updateActionQueue();
            updatePredictionBar();
            updateActionOrderBar();
            updateSystemStatus();
            updateSkillTargetSelect();
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "å…¬å…ƒå‰" : "å…¬å…ƒ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const timeText = `å½“å‰æ—¶é—´: ${era}${year}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹
çºªå¹´: æ˜¥ç§‹${eraYear}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹
æ€»è®¡å°æ—¶: ${tm.totalHours}
æ€»è®¡å¤©æ•°: ${Math.floor(tm.totalHours / 24)}`;

            document.getElementById('timeInfo').textContent = timeText;
        }

        // æ›´æ–°CTBçŠ¶æ€
        function updateCTBStatus() {
            const ctb = gameState.ctbManager;
            const statusText = `ç³»ç»ŸçŠ¶æ€: ${ctb.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
åŸºç¡€å› å­: ${ctb.baseFactor}
æ´»è·ƒè§’è‰²: ${ctb.characters.filter(c => c.isActive).length}/${ctb.characters.length}
é˜Ÿåˆ—é•¿åº¦: ${ctb.actionQueue.length}
å†å²è®°å½•: ${ctb.actionHistory.length}`;

            document.getElementById('ctbStatus').textContent = statusText;
        }

        // æ›´æ–°è§’è‰²ä¿¡æ¯
        function updateCharacterInfo() {
            const characters = gameState.ctbManager.characters;
            let text = `=== è§’è‰²åˆ—è¡¨ (å…± ${characters.length} ä¸ª) ===\n`;
            const displayLimit = 20;

            const charactersToShow = characters.slice(0, displayLimit);

            charactersToShow.forEach(char => {
                const status = char.isActive ? "âœ“" : "âœ—";
                const interval = Math.ceil(gameState.ctbManager.baseFactor / char.speed);
                text += `${status} ${char.name} (${char.faction})\n`;
                text += `  é€Ÿåº¦:${char.speed.toFixed(2)} é—´éš”:${interval}å¤©\n`;
            });

            if (characters.length > displayLimit) {
                text += `\n... (ä»…æ˜¾ç¤ºå‰ ${displayLimit} ä¸ªè§’è‰²)`;
            }

            document.getElementById('characterInfo').textContent = text;
        }

        // æ›´æ–°è¡ŒåŠ¨é˜Ÿåˆ—
        function updateActionQueue() {
            const queue = gameState.ctbManager.actionQueue;
            let text = "=== è¡ŒåŠ¨é˜Ÿåˆ— ===\n";

            queue.slice(0, 8).forEach((action, index) => {
                const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                const days = Math.floor(timeUntil / 24);
                const hours = Math.floor(timeUntil % 24);

                if (index === 0) {
                    text += `â†’ ${action.characterName}\n`;
                } else {
                    text += `  ${action.characterName}\n`;
                }
                text += `    ${days}å¤©${hours}å°æ—¶å\n`;
            });

            document.getElementById('actionQueue').textContent = text;
        }

        // æ›´æ–°é¢„æµ‹æ¡
        function updatePredictionBar() {
            const predictions = predictFutureActions(10); // é¢„æµ‹æœªæ¥10ä¸ªè¡ŒåŠ¨
            let text = "=== æœªæ¥10æ¬¡è¡ŒåŠ¨é¢„æµ‹ ===\n";

            if (predictions.length === 0) {
                text = "æ— æ³•é¢„æµ‹ï¼ˆé˜Ÿåˆ—ä¸ºç©ºæˆ–æœªåˆå§‹åŒ–ï¼‰";
            } else {
                predictions.forEach((action, index) => {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);

                    text += `${String(index + 1).padStart(2, ' ')}. ${action.characterName}\n`;
                    text += `     å°†åœ¨ ${days}å¤©${hours}å°æ—¶åè¡ŒåŠ¨\n`;
                });
            }

            document.getElementById('predictionBar').textContent = text;
        }

        // æ›´æ–°è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡
        function updateActionOrderBar(predictedOrder = null) {
            const bar = document.getElementById('actionOrderBar');
            const ctb = gameState.ctbManager;

            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                bar.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">ç­‰å¾…åˆå§‹åŒ–...</div>';
                return;
            }

            // ä½¿ç”¨é¢„æµ‹é¡ºåºæˆ–å½“å‰é¡ºåº
            const order = predictedOrder || ctb.actionQueue;

            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºDOMå…ƒç´ 
            const existingAvatars = bar.querySelectorAll('.action-order-avatar');
            const needRecreate = existingAvatars.length === 0 ||
                                existingAvatars.length !== Math.min(order.length, 8) ||
                                // æ£€æŸ¥è§’è‰²IDæ˜¯å¦å‘ç”Ÿå˜åŒ–
                                Array.from(existingAvatars).some((avatar, index) => {
                                    if (index >= order.length) return true;
                                    const character = gameState.ctbManager.characters.find(c => c.id === order[index].characterId);
                                    return character && avatar.dataset.characterId != character.id;
                                });

            if (needRecreate) {
                // é‡æ–°åˆ›å»ºDOMå…ƒç´ 
                bar.innerHTML = '';

                // æ˜¾ç¤ºå‰8ä¸ªè¡ŒåŠ¨
                order.slice(0, 8).forEach((action, index) => {
                    const character = gameState.ctbManager.characters.find(c => c.id === action.characterId);
                    if (!character) return;

                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'action-order-avatar';
                    avatarDiv.dataset.characterId = character.id;
                    avatarDiv.dataset.index = index;

                    // è®¾ç½®åˆå§‹ä½ç½®
                    const avatarHeight = 48; // 40px + 8px gap
                    avatarDiv.style.top = `${index * avatarHeight}px`;

                    // æ·»åŠ é˜µè¥æ ·å¼æˆ–è‡ªå®šä¹‰é¢œè‰²
                    if (character.customColor) {
                        // ä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²
                        avatarDiv.style.background = `linear-gradient(135deg, ${character.customColor} 0%, ${darkenColor(character.customColor, 0.2)} 100%)`;
                        avatarDiv.style.color = 'white';
                    } else {
                        // ä½¿ç”¨é˜µè¥æ ·å¼
                        const factionClass = getFactionClass(character.faction);
                        if (factionClass) {
                            avatarDiv.classList.add(factionClass);
                        }
                    }

                    // å½“å‰è¡ŒåŠ¨é«˜äº®
                    if (index === 0) {
                        avatarDiv.classList.add('active');
                    }

                    // å¤´åƒå†…å®¹ï¼ˆæ˜¾ç¤ºå…¨åï¼‰
                    avatarDiv.textContent = character.name;

                    // é˜µè¥å¾½ç« 
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = 'faction-badge';
                    badgeDiv.textContent = character.faction[0];
                    badgeDiv.style.backgroundColor = character.customColor || getFactionColor(character.faction);
                    avatarDiv.appendChild(badgeDiv);

                    // æ—¶é—´ä¿¡æ¯
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time-info';
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);
                    if (days > 0) {
                        timeDiv.textContent = `${days}å¤©${hours}æ—¶`;
                    } else {
                        timeDiv.textContent = `${hours}æ—¶`;
                    }
                    avatarDiv.appendChild(timeDiv);

                    // ç‚¹å‡»äº‹ä»¶ï¼ˆå¯ä»¥æ‰©å±•ä¸ºæŠ€èƒ½é€‰æ‹©ç­‰ï¼‰
                    avatarDiv.onclick = function() {
                        showCharacterDetails(character, action);
                    };

                    bar.appendChild(avatarDiv);
                });
            } else {
                // åªæ›´æ–°ç°æœ‰å…ƒç´ çš„å†…å®¹å’Œä½ç½®ï¼Œä¸é‡æ–°åˆ›å»º
                const avatars = bar.querySelectorAll('.action-order-avatar');
                order.slice(0, 8).forEach((action, index) => {
                    if (index < avatars.length) {
                        const avatar = avatars[index];
                        const character = gameState.ctbManager.characters.find(c => c.id === action.characterId);
                        if (character) {
                            // æ›´æ–°æ–‡æœ¬å†…å®¹
                            avatar.textContent = character.name;
                            avatar.dataset.characterId = character.id;

                            avatar.dataset.index = index;

                            // æ›´æ–°æ—¶é—´ä¿¡æ¯
                            const timeDiv = avatar.querySelector('.time-info');
                            if (timeDiv) {
                                const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                                const days = Math.floor(timeUntil / 24);
                                const hours = Math.floor(timeUntil % 24);
                                if (days > 0) {
                                    timeDiv.textContent = `${days}å¤©${hours}æ—¶`;
                                } else {
                                    timeDiv.textContent = `${hours}æ—¶`;
                                }
                            }

                            // æ›´æ–°é˜µè¥å¾½ç« 
                            const badgeDiv = avatar.querySelector('.faction-badge');
                            if (badgeDiv) {
                                badgeDiv.style.backgroundColor = character.customColor || getFactionColor(character.faction);
                            }
                        }
                    }
                });
            }

            // å¦‚æœæ˜¯é¢„æµ‹æ¨¡å¼ï¼Œæ‰§è¡Œé˜Ÿåˆ—æ’é˜ŸåŠ¨ç”»
            if (predictedOrder && currentPrediction) {
                executeQueueAnimation(predictedOrder, currentPrediction);
            }

            // å¦‚æœè¡ŒåŠ¨æ•°é‡è¶…è¿‡8ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º
            if (order.length > 8) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#7f8c8d';
                moreDiv.style.fontSize = '12px';
                moreDiv.style.marginTop = '10px';
                moreDiv.textContent = `è¿˜æœ‰ ${order.length - 8} ä¸ªè¡ŒåŠ¨...`;
                bar.appendChild(moreDiv);
            }

            // å¦‚æœæ˜¯é¢„æµ‹æ¨¡å¼ï¼Œæ˜¾ç¤ºé¢„æµ‹æç¤º
            if (predictedOrder && currentPrediction) {
                const predictionDiv = document.createElement('div');
                predictionDiv.className = 'prediction-hint';
                predictionDiv.style.textAlign = 'center';
                predictionDiv.style.color = '#27ae60';
                predictionDiv.style.fontSize = '12px';
                predictionDiv.style.marginTop = '10px';
                predictionDiv.style.fontWeight = 'bold';
                predictionDiv.textContent = `ğŸ”® é¢„æµ‹æ¨¡å¼ï¼š${currentPrediction.characterName} å»¶å ${currentPrediction.delayHours} å°æ—¶`;
                bar.appendChild(predictionDiv);
            }
        }

        // æ‰§è¡Œé˜Ÿåˆ—æ’é˜ŸåŠ¨ç”»
        function executeQueueAnimation(predictedOrder, prediction) {
            const bar = document.getElementById('actionOrderBar');
            const avatars = bar.querySelectorAll('.action-order-avatar');
            const avatarHeight = 48;

            // æ‰¾åˆ°ç›®æ ‡è§’è‰²åœ¨åŸå§‹é˜Ÿåˆ—å’Œæ–°é˜Ÿåˆ—ä¸­çš„ä½ç½®
            const originalOrder = gameState.ctbManager.actionQueue.slice(0, 8);
            const targetCharacterId = prediction.characterId;

            const oldIndex = originalOrder.findIndex(action => action.characterId == targetCharacterId);
            const newIndex = predictedOrder.findIndex(action => action.characterId == targetCharacterId);

            if (oldIndex === -1 || newIndex === -1) return;

            // æ¸…é™¤æ‰€æœ‰å¼•åŠ›ç›®æ ‡
            gravityTargets.clear();

            // è®¾ç½®æ‰€æœ‰è§’è‰²çš„å¼•åŠ›ç›®æ ‡åæ ‡
            avatars.forEach(avatar => {
                const avatarIndex = parseInt(avatar.dataset.index);
                const characterId = avatar.dataset.characterId;

                if (characterId == targetCharacterId) {
                    // ç›®æ ‡è§’è‰²ç¬ç§»ï¼ˆä¸ä½¿ç”¨å¼•åŠ›åæ ‡ï¼‰
                    setTimeout(() => {
                        avatar.style.transition = 'none'; // ç¬ç§»
                        avatar.style.top = `${newIndex * avatarHeight}px`;
                        avatar.dataset.index = newIndex;

                        // æ·»åŠ å»¶åæ ‡è¯†
                        avatar.style.borderColor = '#e74c3c';
                        avatar.style.boxShadow = '0 0 12px rgba(231, 76, 60, 0.6)';
                        avatar.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                        avatar.style.color = 'white';

                        // æ¢å¤è¿‡æ¸¡åŠ¨ç”»
                        setTimeout(() => {
                            avatar.style.transition = '';
                        }, 50);
                    }, 200);
                } else {
                    // å…¶ä»–è§’è‰²ä½¿ç”¨å¼•åŠ›åæ ‡ç§»åŠ¨
                    let targetIndex = avatarIndex;
                    if (oldIndex < newIndex) {
                        // å‘åç§»åŠ¨ï¼šè¢«è·¨è¿‡çš„è§’è‰²å‘å‰è¡¥ä½
                        if (avatarIndex > oldIndex && avatarIndex <= newIndex) {
                            targetIndex = avatarIndex - 1;
                        }
                    } else {
                        // å‘å‰ç§»åŠ¨ï¼šè¢«è·¨è¿‡çš„è§’è‰²å‘åè®©ä½
                        if (avatarIndex >= newIndex && avatarIndex < oldIndex) {
                            targetIndex = avatarIndex + 1;
                        }
                    }

                    if (targetIndex !== avatarIndex) {
                        setGravityTarget(characterId, targetIndex);
                    }
                }
            });

            // ç«‹å³åº”ç”¨å¼•åŠ›åŠ¨ç”»
            applyGravityAnimation();
        }

        // è·å–é˜µè¥CSSç±»å
        function getFactionClass(faction) {
            const factionMap = {
                'èœ€å›½': 'faction-shu',
                'é­å›½': 'faction-wei',
                'å´å›½': 'faction-wu',
                'é½å›½': 'faction-qi',
                'æ¥šå›½': 'faction-chu',
                'ç‡•å›½': 'faction-yan',
                'éŸ©å›½': 'faction-han',
                'èµµå›½': 'faction-zhao',
                'ä¸­ç«‹': 'faction-neutral'
            };
            return factionMap[faction] || '';
        }

        // è·å–é˜µè¥é¢œè‰²
        function getFactionColor(faction) {
            const colorMap = {
                'èœ€å›½': '#e74c3c',
                'é­å›½': '#3498db',
                'å´å›½': '#f39c12',
                'é½å›½': '#9b59b6',
                'æ¥šå›½': '#27ae60',
                'ç‡•å›½': '#1abc9c',
                'éŸ©å›½': '#34495e',
                'èµµå›½': '#e67e22',
                'ä¸­ç«‹': '#95a5a6'
            };
            return colorMap[faction] || '#95a5a6';
        }

        // é¢œè‰²å˜æš—è¾…åŠ©å‡½æ•°
        function darkenColor(color, factor) {
            // ç®€å•çš„é¢œè‰²å˜æš—ç®—æ³•
            const hex = color.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) * (1 - factor));
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) * (1 - factor));
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) * (1 - factor));
            return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºè§’è‰²è¯¦æƒ…ï¼ˆå¯æ‰©å±•ä¸ºæŠ€èƒ½é€‰æ‹©ç­‰ï¼‰
        function showCharacterDetails(character, action) {
            const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
            const days = Math.floor(timeUntil / 24);
            const hours = Math.floor(timeUntil % 24);

            let timeText = '';
            if (days > 0) {
                timeText = `${days}å¤©${hours}å°æ—¶å`;
            } else {
                timeText = `${hours}å°æ—¶å`;
            }

            addActionLog(`è§’è‰²è¯¦æƒ…: ${character.name} (${character.faction}) - é€Ÿåº¦:${character.speed} - ${timeText}è¡ŒåŠ¨`);
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            const ctb = gameState.ctbManager;
            document.getElementById('systemStatus').textContent = ctb.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            document.getElementById('characterCount').textContent = ctb.characters.length;
            document.getElementById('actionCount').textContent = ctb.actionHistory.length;
        }

        // æ·»åŠ è¡ŒåŠ¨å†å²è®°å½•
        function addActionLog(message) {
            const historyDiv = document.getElementById('actionHistory');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

            historyDiv.appendChild(logEntry);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // ä¿æŒæœ€æ–°50æ¡è®°å½•
            while (historyDiv.children.length > 50) {
                historyDiv.removeChild(historyDiv.firstChild);
            }
        }

        // é¢„æµ‹æœªæ¥è¡ŒåŠ¨
        function predictFutureActions(count) {
            const ctb = gameState.ctbManager;
            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                return [];
            }

            // ä½¿ç”¨æ·±æ‹·è´åˆ›å»ºæ¨¡æ‹Ÿç¯å¢ƒ
            let simQueue = JSON.parse(JSON.stringify(ctb.actionQueue));

            const predictions = [];

            for (let i = 0; i < count; i++) {
                if (simQueue.length === 0) break;

                // è·å–ä¸‹ä¸€ä¸ªè¡ŒåŠ¨ (JSä¸­shift()ä»æ•°ç»„å¤´éƒ¨å–å‡º)
                const nextAction = simQueue.shift();
                predictions.push(nextAction);

                // å®‰æ’è¯¥è§’è‰²çš„ä¸‹ä¸€æ¬¡è¡ŒåŠ¨
                const character = ctb.characters.find(c => c.id === nextAction.characterId);
                if (character && character.isActive) {
                    const interval = Math.ceil(ctb.baseFactor / character.speed);
                    const nextTriggerTime = nextAction.triggerTime + (interval * 24);

                    simQueue.push({
                        id: -1, // æ¨¡æ‹Ÿè¡ŒåŠ¨ID
                        characterId: character.id,
                        characterName: character.name,
                        triggerTime: nextTriggerTime,
                        actionType: 'attack'
                    });

                    // ä¿æŒæ¨¡æ‹Ÿé˜Ÿåˆ—æ’åº
                    simQueue.sort((a, b) => a.triggerTime - b.triggerTime);
                }
            }

            return predictions;
        }

        // CTBç³»ç»Ÿæ§åˆ¶å‡½æ•°
        function initializeCTB() {
            gameState.ctbManager.characters = [...testCharacters];
            gameState.ctbManager.isInitialized = true;
            gameState.ctbManager.actionQueue = [];

            // ç”Ÿæˆåˆå§‹è¡ŒåŠ¨é˜Ÿåˆ—
            gameState.ctbManager.characters.forEach(char => {
                if (char.isActive) {
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const intervalDays = Math.ceil(baseFactor / char.speed);
                    const intervalHours = intervalDays * 24;

                    // é¦–æ¬¡è¡ŒåŠ¨æ—¶é—´åœ¨ (0, intervalHours] åŒºé—´å†…éšæœºåˆ†å¸ƒ
                    // è¿™é¿å…äº†æ‰€æœ‰è§’è‰²åœ¨åŒä¸€å¤©åŒæ­¥å…¶è¡ŒåŠ¨å‘¨æœŸ
                    const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                    const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                    gameState.ctbManager.actionQueue.push({
                        id: gameState.ctbManager.nextActionId++,
                        characterId: char.id,
                        characterName: char.name,
                        triggerTime: triggerTime,
                        actionType: 'attack'
                    });
                }
            });

            // æŒ‰è§¦å‘æ—¶é—´æ’åº
            gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

            addActionLog("CTBç³»ç»Ÿå·²åˆå§‹åŒ–");
            updateAllDisplays();
        }

        function executeNextAction() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            // ä½¿ç”¨å¼•åŠ›åæ ‡ç³»ç»Ÿæ‰§è¡ŒåŠ¨ç”»
            const bar = document.getElementById('actionOrderBar');
            const avatars = bar.querySelectorAll('.action-order-avatar');
            const avatarHeight = 48;

            if (avatars.length > 0) {
                // æ¸…é™¤æ‰€æœ‰å¼•åŠ›ç›®æ ‡
                gravityTargets.clear();

                // ç¬¬ä¸€ä¸ªå¤´åƒä½¿ç”¨å¼•åŠ›åæ ‡ç§»åŠ¨åˆ°æœ€åº•éƒ¨ï¼ˆæ¶ˆå¤±æ•ˆæœï¼‰
                const firstAvatar = avatars[0];
                const firstCharacterId = firstAvatar.dataset.characterId;
                setGravityTarget(firstCharacterId, -1); // ç§»åŠ¨åˆ°-1ä½ç½®ï¼ˆåº•éƒ¨å¤–ï¼‰

                // å…¶ä»–å¤´åƒä½¿ç”¨å¼•åŠ›åæ ‡ä¸Šæµ®
                for (let i = 1; i < avatars.length; i++) {
                    const avatar = avatars[i];
                    const characterId = avatar.dataset.characterId;
                    const newIndex = i - 1;

                    // è®¾ç½®å¼•åŠ›ç›®æ ‡
                    setGravityTarget(characterId, newIndex);
                }

                // åº”ç”¨å¼•åŠ›åŠ¨ç”»
                applyGravityAnimation();

                // åŠ¨ç”»å®Œæˆåæ‰§è¡Œå®é™…é€»è¾‘
                setTimeout(() => {
                    executeNextActionLogic();
                }, 600); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            } else {
                executeNextActionLogic();
            }
        }

        // å®é™…çš„æ‰§è¡Œé€»è¾‘
        function executeNextActionLogic() {
            const action = gameState.ctbManager.actionQueue.shift();
            if (!action) {
                addActionLog("æ²¡æœ‰å¾…æ‰§è¡Œçš„è¡ŒåŠ¨");
                return;
            }

            // æ¨è¿›æ—¶é—´åˆ°è¡ŒåŠ¨æ—¶é—´
            gameState.timeManager.totalHours = action.triggerTime;
            updateTimeFromTotalHours();

            // è®°å½•è¡ŒåŠ¨
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "å…¬å…ƒå‰" : "å…¬å…ƒ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const logMessage = `æ˜¥ç§‹${eraYear}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹ (${era}${year}å¹´${tm.currentMonth}æœˆ${tm.currentDay}æ—¥${tm.currentHour}ç‚¹) - ${action.characterName} è¡ŒåŠ¨`;
            addActionLog(logMessage);

            // æ·»åŠ åˆ°å†å²
            gameState.ctbManager.actionHistory.push({
                ...action,
                executedTime: action.triggerTime,
                timestamp: Date.now()
            });

            // ä¸ºè¯¥è§’è‰²å®‰æ’ä¸‹æ¬¡è¡ŒåŠ¨
            const character = gameState.ctbManager.characters.find(c => c.id === action.characterId);
            if (character && character.isActive) {
                const interval = Math.ceil(gameState.ctbManager.baseFactor / character.speed);
                const nextTriggerTime = action.triggerTime + (interval * 24);

                gameState.ctbManager.actionQueue.push({
                    id: gameState.ctbManager.nextActionId++,
                    characterId: character.id,
                    characterName: character.name,
                    triggerTime: nextTriggerTime,
                    actionType: 'attack'
                });

                // é‡æ–°æ’åºé˜Ÿåˆ—
                gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);
            }

            // å»¶è¿Ÿæ›´æ–°æ˜¾ç¤ºï¼Œè®©å¼•åŠ›åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                updateAllDisplays();
            }, 100);
        }

        function skipToNext() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const nextAction = gameState.ctbManager.actionQueue[0];
            if (!nextAction) {
                addActionLog("æ²¡æœ‰å¾…æ‰§è¡Œçš„è¡ŒåŠ¨");
                return;
            }

            // ç›´æ¥è·³è½¬æ—¶é—´
            gameState.timeManager.totalHours = nextAction.triggerTime;
            updateTimeFromTotalHours();

            addActionLog(`æ—¶é—´å·²è·³è½¬åˆ° ${nextAction.characterName} çš„è¡ŒåŠ¨æ—¶é—´`);
            updateAllDisplays();
        }

        function changeBaseFactor() {
            const newFactor = parseInt(document.getElementById('factorInput').value);
            if (newFactor && newFactor > 0) {
                gameState.ctbManager.baseFactor = newFactor;
                addActionLog(`åŸºç¡€å› å­å·²ä¿®æ”¹ä¸º: ${newFactor}`);
                updateAllDisplays();
            } else {
                addActionLog("åŸºç¡€å› å­å¿…é¡»å¤§äº0");
            }
        }

        function resetCTB(silent = false) {
            gameState.ctbManager = {
                isInitialized: false,
                baseFactor: 100,
                characters: [],
                actionQueue: [],
                actionHistory: [],
                nextActionId: 1
            };

            document.getElementById('factorInput').value = "100";
            if (!silent) {
                addActionLog("CTBç³»ç»Ÿå·²é‡ç½®");
            }
            // Clear stress test results on reset
            const resultDiv = document.getElementById('stressTestResult');
            if (resultDiv) resultDiv.textContent = "";

            updateAllDisplays();
        }

        function toggleCharacterActive() {
            if (gameState.ctbManager.characters.length > 0) {
                const char = gameState.ctbManager.characters[0];
                char.isActive = !char.isActive;
                const status = char.isActive ? "æ¿€æ´»" : "åœç”¨";
                addActionLog(`${char.name} å·²${status}`);
                updateAllDisplays();
            }
        }

        function addRandomCharacter() {
            const names = ["èµµå…­", "å­™ä¸ƒ", "å‘¨å…«", "å´ä¹", "éƒ‘å"];
            const factions = ["é½å›½", "æ¥šå›½", "ç‡•å›½", "éŸ©å›½", "èµµå›½"];

            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomFaction = factions[Math.floor(Math.random() * factions.length)];
            const randomSpeed = Math.floor(Math.random() * 8) + 3; // 3-10

            const newChar = {
                id: Date.now(),
                name: randomName,
                faction: randomFaction,
                speed: randomSpeed,
                isActive: true
            };

            gameState.ctbManager.characters.push(newChar);
            addActionLog(`æ·»åŠ è§’è‰²: ${randomName}(${randomFaction}) é€Ÿåº¦:${randomSpeed}`);
            updateAllDisplays();
        }

        // é¢„æµ‹æ¼”ç¤ºåŠŸèƒ½
        function showPredictionDemo() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const ctb = gameState.ctbManager;
            if (ctb.actionQueue.length < 2) {
                addActionLog("éœ€è¦è‡³å°‘2ä¸ªè¡ŒåŠ¨æ‰èƒ½æ¼”ç¤ºé¢„æµ‹æ•ˆæœ");
                return;
            }

            // åˆ›å»ºé¢„æµ‹é¡ºåºï¼ˆæ¨¡æ‹Ÿç¬¬ä¸€ä¸ªè§’è‰²è¡ŒåŠ¨åï¼Œç¬¬äºŒä¸ªè§’è‰²æå‰è¡ŒåŠ¨ï¼‰
            const predictedOrder = [...ctb.actionQueue];

            // æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªè§’è‰²è¡ŒåŠ¨åï¼Œç¬¬äºŒä¸ªè§’è‰²çš„è¡ŒåŠ¨æ—¶é—´æå‰
            if (predictedOrder.length >= 2) {
                const firstAction = predictedOrder[0];
                const secondAction = predictedOrder[1];

                // æ¨¡æ‹Ÿç¬¬äºŒä¸ªè§’è‰²å› ä¸ºæŸç§æŠ€èƒ½æˆ–æ•ˆæœæå‰è¡ŒåŠ¨
                const timeAdvance = Math.floor(Math.random() * 24) + 1; // æå‰1-24å°æ—¶
                secondAction.triggerTime = firstAction.triggerTime + timeAdvance;

                // é‡æ–°æ’åº
                predictedOrder.sort((a, b) => a.triggerTime - b.triggerTime);

                addActionLog(`ğŸ”® é¢„æµ‹æ¼”ç¤º: å‡è®¾${firstAction.characterName}è¡ŒåŠ¨åï¼Œ${secondAction.characterName}æå‰${timeAdvance}å°æ—¶è¡ŒåŠ¨`);

                // æ˜¾ç¤ºé¢„æµ‹æ•ˆæœ
                updateActionOrderBar(predictedOrder);

                // 3ç§’åæ¢å¤åŸå§‹æ˜¾ç¤º
                setTimeout(() => {
                    updateActionOrderBar();
                    addActionLog("é¢„æµ‹æ¼”ç¤ºç»“æŸï¼Œæ¢å¤åŸå§‹é¡ºåº");
                }, 3000);
            }
        }

        // ä»æ€»å°æ—¶æ•°æ›´æ–°æ—¥æœŸæ—¶é—´
        function updateTimeFromTotalHours() {
            const totalHours = gameState.timeManager.totalHours;
            const totalDays = Math.floor(totalHours / 24);
            const hours = totalHours % 24;

            // ç®€åŒ–çš„æ—¥æœŸè®¡ç®—ï¼ˆ360å¤©/å¹´ï¼Œ30å¤©/æœˆï¼‰
            const startYear = window.gameConfig.EPOCH_START_YEAR;
            const years = Math.floor(totalDays / 360);
            const remainingDays = totalDays % 360;
            const months = Math.floor(remainingDays / 30);
            const days = remainingDays % 30;

            gameState.timeManager.currentYear = startYear + years;
            gameState.timeManager.currentMonth = months + 1;
            gameState.timeManager.currentDay = days + 1;
            gameState.timeManager.currentHour = hours;
        }

        // 100äººæµ‹è¯•æ¨¡å¼
        function runMediumTest() {
            addActionLog("âš¡ å¼€å§‹100äººæµ‹è¯•åˆå§‹åŒ–...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "åˆå§‹åŒ–ä¸­...";

            setTimeout(() => {
                try {
                    // 1. é‡ç½®ç³»ç»ŸçŠ¶æ€
                    resetCTB(true);

                    // 2. è®¾ç½®å‚æ•°
                    const characterCount = 100;
                    const averageIntervalDays = 30; // æ›´çŸ­çš„é—´éš”ï¼Œä¾¿äºè§‚å¯Ÿ
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ç”Ÿæˆéšæœºåå­—å’Œé¢œè‰²
                    const surnames = ['å¼ ', 'æ', 'ç‹', 'èµµ', 'é™ˆ', 'åˆ˜', 'æ¨', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—', 'æ¢', 'å®‹', 'éƒ‘', 'è°¢', 'éŸ©', 'å”', 'å†¯', 'äº', 'è‘£', 'è§', 'ç¨‹', 'æ›¹', 'è¢', 'é‚“', 'è®¸', 'å‚…', 'æ²ˆ', 'æ›¾', 'å½­', 'å•', 'è‹', 'å¢', 'è’‹', 'è”¡', 'è´¾', 'ä¸', 'é­', 'è–›', 'å¶', 'é˜', 'ä½™', 'æ½˜', 'æœ', 'æˆ´', 'å¤', 'é’Ÿ', 'æ±ª', 'ç”°', 'ä»»', 'å§œ', 'èŒƒ', 'æ–¹', 'çŸ³', 'å§š', 'è°­', 'å»–', 'é‚¹', 'ç†Š', 'é‡‘', 'é™†', 'éƒ', 'å­”', 'ç™½', 'å´”', 'åº·', 'æ¯›', 'é‚±', 'ç§¦', 'æ±Ÿ', 'å²', 'é¡¾', 'ä¾¯', 'é‚µ', 'å­Ÿ', 'é¾™', 'ä¸‡', 'æ®µ', 'é›·', 'é’±', 'æ±¤', 'å°¹', 'é»', 'æ˜“', 'å¸¸', 'æ­¦', 'ä¹”', 'è´º', 'èµ–', 'é¾š', 'æ–‡'];
                    const givenNames = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°', 'éœ', 'å¹³', 'åˆš', 'æ¡‚è‹±', 'å»ºå', 'å»ºå›½', 'å»ºå†›', 'å»ºå¹³', 'å»ºå', 'å»ºæ˜', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºå‹‡', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»', 'å»ºå‹‡', 'å»ºåˆš', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»'];
                    const factions = ['èœ€å›½', 'é­å›½', 'å´å›½', 'é½å›½', 'æ¥šå›½', 'ç‡•å›½', 'éŸ©å›½', 'èµµå›½', 'ç§¦å›½', 'æ™‹å›½', 'å®‹å›½', 'å«å›½', 'éƒ‘å›½', 'é²å›½', 'è¶Šå›½', 'ä¸­å±±å›½', 'æ»•å›½', 'è–›å›½', 'è’å›½', 'é‚¾å›½', 'éƒ¯å›½', 'å°é‚¾å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½'];

                    // é¢„ç”Ÿæˆéšæœºé¢œè‰²æ± 
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ç”Ÿæˆè§’è‰²å¹¶è®¡ç®—ç†è®ºå¹³å‡å€¼
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ç”Ÿæˆéšæœºåå­—
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // éšæœºé˜µè¥
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // åˆ†é…å›ºå®šéšæœºé¢œè‰²ï¼ˆåŸºäºè§’è‰²IDç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²å±æ€§
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. å®‰æ’é¦–æ¬¡è¡ŒåŠ¨
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // é¦–æ¬¡è¡ŒåŠ¨æ—¶é—´åœ¨ (0, intervalHours] åŒºé—´å†…éšæœºåˆ†å¸ƒ
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextActionId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. æ’åºè¡ŒåŠ¨é˜Ÿåˆ—
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. æ˜¾ç¤ºç†è®ºè®¡ç®—ç»“æœ
                    const resultText = `--- 100äººæµ‹è¯•ç»“æœ ---\nè§’è‰²æ•°é‡: ${characterCount}\nç›®æ ‡è¡ŒåŠ¨é—´éš”: ${averageIntervalDays} å¤©\nç†è®ºå¹³å‡æ¯æ—¥è¡ŒåŠ¨: ${totalActionsPerDay.toFixed(2)} äºº\n\nğŸ’¡ é€‚åˆæµ‹è¯•è¡ŒåŠ¨é¡ºåºé¢„æµ‹ç«–æ¡æ•ˆæœ`;
                    resultDiv.textContent = resultText;

                    addActionLog(`âœ… 100äººæµ‹è¯•åˆå§‹åŒ–å®Œæˆï¼Œå·²ç”Ÿæˆ ${characterCount} ä¸ªè§’è‰²ã€‚`);

                    // 8. æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    updateAllDisplays();

                } catch (e) {
                    console.error("100äººæµ‹è¯•åˆå§‹åŒ–å‡ºé”™:", e);
                    resultDiv.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
                    addActionLog("âŒ 100äººæµ‹è¯•åˆå§‹åŒ–å¤±è´¥ã€‚");
                }
            }, 50);
        }

        function runStressTest() {
            addActionLog("ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯•åˆå§‹åŒ–...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "åˆå§‹åŒ–ä¸­...";

            setTimeout(() => {
                try {
                    // 1. é‡ç½®ç³»ç»ŸçŠ¶æ€
                    resetCTB(true);

                    // 2. è®¾ç½®å‚æ•°
                    const characterCount = 10000;
                    const averageIntervalDays = 90;
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ç”Ÿæˆéšæœºåå­—å’Œé¢œè‰²
                    const surnames = ['å¼ ', 'æ', 'ç‹', 'èµµ', 'é™ˆ', 'åˆ˜', 'æ¨', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—', 'æ¢', 'å®‹', 'éƒ‘', 'è°¢', 'éŸ©', 'å”', 'å†¯', 'äº', 'è‘£', 'è§', 'ç¨‹', 'æ›¹', 'è¢', 'é‚“', 'è®¸', 'å‚…', 'æ²ˆ', 'æ›¾', 'å½­', 'å•', 'è‹', 'å¢', 'è’‹', 'è”¡', 'è´¾', 'ä¸', 'é­', 'è–›', 'å¶', 'é˜', 'ä½™', 'æ½˜', 'æœ', 'æˆ´', 'å¤', 'é’Ÿ', 'æ±ª', 'ç”°', 'ä»»', 'å§œ', 'èŒƒ', 'æ–¹', 'çŸ³', 'å§š', 'è°­', 'å»–', 'é‚¹', 'ç†Š', 'é‡‘', 'é™†', 'éƒ', 'å­”', 'ç™½', 'å´”', 'åº·', 'æ¯›', 'é‚±', 'ç§¦', 'æ±Ÿ', 'å²', 'é¡¾', 'ä¾¯', 'é‚µ', 'å­Ÿ', 'é¾™', 'ä¸‡', 'æ®µ', 'é›·', 'é’±', 'æ±¤', 'å°¹', 'é»', 'æ˜“', 'å¸¸', 'æ­¦', 'ä¹”', 'è´º', 'èµ–', 'é¾š', 'æ–‡'];
                    const givenNames = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°', 'éœ', 'å¹³', 'åˆš', 'æ¡‚è‹±', 'å»ºå', 'å»ºå›½', 'å»ºå†›', 'å»ºå¹³', 'å»ºå', 'å»ºæ˜', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºå‹‡', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»', 'å»ºå‹‡', 'å»ºåˆš', 'å»ºå¼º', 'å»ºä¼Ÿ', 'å»ºæ°', 'å»ºæ³¢', 'å»ºæ¶›', 'å»ºæ–Œ', 'å»ºè¾‰', 'å»ºå³°', 'å»ºæ—', 'å»ºä¸œ', 'å»ºå—', 'å»ºè¥¿', 'å»ºåŒ—', 'å»ºä¸­', 'å»ºå’Œ', 'å»ºå®‰', 'å»ºåº·', 'å»ºæ–‡', 'å»ºæ­¦', 'å»ºå¾·', 'å»ºä»', 'å»ºä¹‰', 'å»ºç¤¼', 'å»ºæ™º', 'å»ºä¿¡', 'å»ºå¿ ', 'å»ºå­', 'å»ºèŠ‚', 'å»ºå»‰', 'å»ºè€»'];
                    const factions = ['èœ€å›½', 'é­å›½', 'å´å›½', 'é½å›½', 'æ¥šå›½', 'ç‡•å›½', 'éŸ©å›½', 'èµµå›½', 'ç§¦å›½', 'æ™‹å›½', 'å®‹å›½', 'å«å›½', 'éƒ‘å›½', 'é²å›½', 'è¶Šå›½', 'ä¸­å±±å›½', 'æ»•å›½', 'è–›å›½', 'è’å›½', 'é‚¾å›½', 'éƒ¯å›½', 'å°é‚¾å›½', 'é„«å›½', 'é„…å›½', 'é„«å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½', 'é„…å›½'];

                    // é¢„ç”Ÿæˆéšæœºé¢œè‰²æ± 
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ç”Ÿæˆè§’è‰²å¹¶è®¡ç®—ç†è®ºå¹³å‡å€¼
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ç”Ÿæˆéšæœºåå­—
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // éšæœºé˜µè¥
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // åˆ†é…å›ºå®šéšæœºé¢œè‰²ï¼ˆåŸºäºè§’è‰²IDç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²å±æ€§
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. å®‰æ’é¦–æ¬¡è¡ŒåŠ¨
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // é¦–æ¬¡è¡ŒåŠ¨æ—¶é—´åœ¨ (0, intervalHours] åŒºé—´å†…éšæœºåˆ†å¸ƒ
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextActionId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. æ’åºè¡ŒåŠ¨é˜Ÿåˆ—
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. æ˜¾ç¤ºç†è®ºè®¡ç®—ç»“æœ
                    const resultText = `--- å‹åŠ›æµ‹è¯•ç»“æœ ---\nè§’è‰²æ•°é‡: ${characterCount}\nç›®æ ‡è¡ŒåŠ¨é—´éš”: ${averageIntervalDays} å¤©\nç†è®ºå¹³å‡æ¯æ—¥è¡ŒåŠ¨: ${totalActionsPerDay.toFixed(2)} äºº`;
                    resultDiv.textContent = resultText;

                    addActionLog(`âœ… å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å®Œæˆï¼Œå·²ç”Ÿæˆ ${characterCount} ä¸ªè§’è‰²ã€‚`);

                    // 8. æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    updateAllDisplays();

                } catch (e) {
                    console.error("å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å‡ºé”™:", e);
                    resultDiv.textContent = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
                    addActionLog("âŒ å‹åŠ›æµ‹è¯•åˆå§‹åŒ–å¤±è´¥ã€‚");
                }
            }, 50);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDisplays();
            addActionLog("ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼Œè¯·ç‚¹å‡»'åˆå§‹åŒ–CTB'å¼€å§‹");
        });

        // æŠ€èƒ½ç³»ç»Ÿç›¸å…³å˜é‡
        let currentPrediction = null;
        let apiServerUrl = 'http://localhost:8001';

        // å¼•åŠ›åæ ‡ç³»ç»Ÿ
        let gravityTargets = new Map(); // å­˜å‚¨æ¯ä¸ªè§’è‰²çš„å¼•åŠ›ç›®æ ‡åæ ‡
        let animationQueue = []; // åŠ¨ç”»é˜Ÿåˆ—ï¼Œæ”¯æŒè¿ç»­æ“ä½œ
        let isAnimating = false; // æ˜¯å¦æ­£åœ¨æ‰§è¡ŒåŠ¨ç”»

        // è®¾ç½®å¼•åŠ›ç›®æ ‡åæ ‡
        function setGravityTarget(characterId, targetIndex) {
            const avatarHeight = 48;
            let targetY;

            if (targetIndex === -1) {
                // -1è¡¨ç¤ºç§»åŠ¨åˆ°åº•éƒ¨å¤–ï¼ˆæ¶ˆå¤±æ•ˆæœï¼‰
                targetY = 400; // ç§»åŠ¨åˆ°è¶³å¤Ÿè¿œçš„ä½ç½®
            } else {
                targetY = targetIndex * avatarHeight;
            }

            gravityTargets.set(characterId, targetY);
        }

        // æ¸…é™¤å¼•åŠ›ç›®æ ‡åæ ‡
        function clearGravityTarget(characterId) {
            gravityTargets.delete(characterId);
        }

        // åº”ç”¨å¼•åŠ›åæ ‡åŠ¨ç”»
        function applyGravityAnimation() {
            if (isAnimating) {
                // å¦‚æœæ­£åœ¨åŠ¨ç”»ï¼ŒåŠ å…¥é˜Ÿåˆ—
                animationQueue.push(() => applyGravityAnimation());
                return;
            }

            isAnimating = true;
            const bar = document.getElementById('actionOrderBar');
            const avatars = bar.querySelectorAll('.action-order-avatar');
            let animationsInProgress = 0;

            avatars.forEach((avatar, index) => {
                const characterId = avatar.dataset.characterId;
                const targetY = gravityTargets.get(characterId);

                if (targetY !== undefined) {
                    const currentY = parseInt(avatar.style.top) || (index * 48);

                    if (Math.abs(targetY - currentY) > 1) { // æœ‰ç§»åŠ¨è·ç¦»
                        animationsInProgress++;

                        // æ ¹æ®ä½ç½®è®¾ç½®ä¸åŒçš„åŠ¨ç”»é€Ÿåº¦ï¼ˆå‰æ’å¿«åæ’æ…¢ï¼‰
                        let speedClass = 'gravity-medium';
                        if (index < 3) {
                            speedClass = 'gravity-fast';
                        } else if (index > 5) {
                            speedClass = 'gravity-slow';
                        }

                        avatar.classList.add(speedClass);
                        avatar.style.top = `${targetY}px`;

                        // åŠ¨ç”»å®Œæˆåæ¸…ç†
                        setTimeout(() => {
                            avatar.classList.remove(speedClass);
                            animationsInProgress--;

                            if (animationsInProgress === 0) {
                                isAnimating = false;
                                // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªåŠ¨ç”»
                                if (animationQueue.length > 0) {
                                    const nextAnimation = animationQueue.shift();
                                    nextAnimation();
                                }
                            }
                        }, index < 3 ? 400 : index > 5 ? 800 : 600);
                    } else {
                        // æ²¡æœ‰ç§»åŠ¨è·ç¦»ï¼Œç›´æ¥æ¸…é™¤ç›®æ ‡
                        clearGravityTarget(characterId);
                    }
                }
            });

            // å¦‚æœæ²¡æœ‰åŠ¨ç”»éœ€è¦æ‰§è¡Œ
            if (animationsInProgress === 0) {
                isAnimating = false;
                if (animationQueue.length > 0) {
                    const nextAnimation = animationQueue.shift();
                    nextAnimation();
                }
            }
        }

        // æ›´æ–°è§’è‰²é€‰æ‹©å™¨
        function updateSkillTargetSelect() {
            const select = document.getElementById('skillTargetSelect');
            const ctb = gameState.ctbManager;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '<option value="">é€‰æ‹©è§’è‰²...</option>';

            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                return;
            }

            // æŒ‰è¡ŒåŠ¨é¡ºåºæ’åºè§’è‰²
            const sortedCharacters = [];
            ctb.actionQueue.forEach(action => {
                const character = ctb.characters.find(c => c.id === action.characterId);
                if (character && !sortedCharacters.find(c => c.id === character.id)) {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);
                    const timeText = days > 0 ? `${days}å¤©${hours}æ—¶å` : `${hours}æ—¶å`;

                    sortedCharacters.push({
                        ...character,
                        timeText: timeText,
                        triggerTime: action.triggerTime
                    });
                }
            });

            // æ·»åŠ è§’è‰²é€‰é¡¹ï¼ˆæŒ‰è¡ŒåŠ¨é¡ºåºï¼‰
            sortedCharacters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = `${char.name} (${char.faction}) - ${char.timeText}`;
                select.appendChild(option);
            });
        }

        // é¢„æµ‹æŠ€èƒ½æ•ˆæœ
        function predictSkillEffect() {
            const characterId = document.getElementById('skillTargetSelect').value;
            const delayHours = parseInt(document.getElementById('delayHoursInput').value);

            if (!characterId) {
                alert('è¯·é€‰æ‹©ç›®æ ‡è§’è‰²');
                return;
            }

            if (delayHours <= 0) {
                alert('å»¶åå°æ—¶æ•°å¿…é¡»å¤§äº0');
                return;
            }

            const character = gameState.ctbManager.characters.find(c => c.id == characterId);
            if (!character) {
                alert('è§’è‰²ä¸å­˜åœ¨');
                return;
            }

            // æ¨¡æ‹Ÿé¢„æµ‹æ•ˆæœï¼ˆå®é™…åº”è¯¥è°ƒç”¨APIï¼‰
            try {
                // åˆ›å»ºé¢„æµ‹æ•°æ®
                const predictedActions = simulateSkillPrediction(characterId, delayHours);
                currentPrediction = {
                    characterId: characterId,
                    characterName: character.name,
                    delayHours: delayHours,
                    predictedActions: predictedActions
                };

                // æ›´æ–°æ˜¾ç¤ºï¼ˆä¸é‡æ–°åˆ›å»ºDOMï¼‰
                updateActionOrderBar(predictedActions);
                addActionLog(`ğŸ”® é¢„æµ‹æŠ€èƒ½æ•ˆæœï¼š${character.name} å»¶å ${delayHours} å°æ—¶`);

            } catch (error) {
                console.error('é¢„æµ‹å¤±è´¥:', error);
                alert('é¢„æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            }
        }

        // æ¨¡æ‹ŸæŠ€èƒ½é¢„æµ‹ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨APIï¼‰
        function simulateSkillPrediction(characterId, delayHours) {
            const ctb = gameState.ctbManager;
            const currentQueue = [...ctb.actionQueue];

            // æ‰¾åˆ°ç›®æ ‡è§’è‰²çš„è¡ŒåŠ¨
            const targetAction = currentQueue.find(action => action.characterId == characterId);
            if (!targetAction) {
                return currentQueue;
            }

            // åˆ›å»ºæ–°çš„é¢„æµ‹é˜Ÿåˆ—
            const predictedQueue = currentQueue.map(action => {
                if (action.characterId == characterId) {
                    return {
                        ...action,
                        triggerTime: action.triggerTime + delayHours,
                        isDelayed: true
                    };
                }
                return action;
            });

            // é‡æ–°æ’åº
            predictedQueue.sort((a, b) => a.triggerTime - b.triggerTime);

            return predictedQueue;
        }

        // åº”ç”¨æŠ€èƒ½æ•ˆæœ
        function applySkillEffect() {
            if (!currentPrediction) {
                alert('è¯·å…ˆé¢„æµ‹æŠ€èƒ½æ•ˆæœ');
                return;
            }

            const { characterId, characterName, delayHours } = currentPrediction;

            // æ¨¡æ‹Ÿåº”ç”¨æŠ€èƒ½æ•ˆæœï¼ˆå®é™…åº”è¯¥è°ƒç”¨APIï¼‰
            try {
                // æ›´æ–°çœŸå®é˜Ÿåˆ—
                const ctb = gameState.ctbManager;
                const targetAction = ctb.actionQueue.find(action => action.characterId == characterId);

                if (targetAction) {
                    targetAction.triggerTime += delayHours;
                    // é‡æ–°æ’åº
                    ctb.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    addActionLog(`âœ¨ æŠ€èƒ½å·²åº”ç”¨ï¼š${characterName} å»¶å ${delayHours} å°æ—¶`);

                    // æ·»åŠ æŠ€èƒ½åº”ç”¨æˆåŠŸåŠ¨ç”»
                    const avatars = document.querySelectorAll('.action-order-avatar');
                    avatars.forEach(avatar => {
                        if (avatar.textContent.includes(characterName[0])) {
                            avatar.classList.add('skill-applied');
                            // 1ç§’åç§»é™¤åŠ¨ç”»ç±»
                            setTimeout(() => {
                                avatar.classList.remove('skill-applied');
                            }, 1000);
                        }
                    });

                    // æ¸…é™¤é¢„æµ‹çŠ¶æ€
                    clearPrediction();

                    // æ›´æ–°æ˜¾ç¤º
                    updateAllDisplays();
                }

            } catch (error) {
                console.error('åº”ç”¨æŠ€èƒ½å¤±è´¥:', error);
                alert('åº”ç”¨æŠ€èƒ½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            }
        }

        // æ¸…é™¤é¢„æµ‹
        function clearPrediction() {
            currentPrediction = null;

            // æ¸…é™¤æ‰€æœ‰å¼•åŠ›ç›®æ ‡
            gravityTargets.clear();

            // æ¸…é™¤æ‰€æœ‰åŠ¨ç”»ç›¸å…³çš„CSSç±»å¹¶é‡ç½®ä½ç½®
            const avatars = document.querySelectorAll('.action-order-avatar');
            avatars.forEach(avatar => {
                avatar.classList.remove('delayed', 'prediction-mode', 'predicted', 'moving', 'teleporting', 'float-up', 'fade-out', 'gravity-moving', 'gravity-fast', 'gravity-medium', 'gravity-slow');
                // é‡ç½®æ ·å¼
                avatar.style.borderColor = '';
                avatar.style.boxShadow = '';
                avatar.style.background = '';
                avatar.style.color = '';
                avatar.style.opacity = '';
                avatar.style.transition = '';
                avatar.style.top = '';
            });

            updateActionOrderBar(); // ä½¿ç”¨çœŸå®æ•°æ®æ›´æ–°
            addActionLog('ğŸ”„ å·²æ¸…é™¤é¢„æµ‹æ•ˆæœ');
        }

        // æµ‹è¯•å¼•åŠ›åæ ‡åŠ¨ç”»
        function testGravityAnimation() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("è¯·å…ˆåˆå§‹åŒ–CTBç³»ç»Ÿ");
                return;
            }

            const bar = document.getElementById('actionOrderBar');
            const avatars = bar.querySelectorAll('.action-order-avatar');

            if (avatars.length === 0) {
                addActionLog("æ²¡æœ‰è§’è‰²å¯ä»¥æµ‹è¯•");
                return;
            }

            // å¼ºåˆ¶åœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
            isAnimating = false;
            animationQueue.length = 0;
            gravityTargets.clear();

            // ç«‹å³é‡ç½®æ‰€æœ‰è§’è‰²ä½ç½®åˆ°åŸå§‹çŠ¶æ€
            avatars.forEach((avatar, index) => {
                avatar.style.transition = 'none';
                avatar.style.top = `${index * 48}px`;
                avatar.classList.remove('gravity-fast', 'gravity-medium', 'gravity-slow');
                setTimeout(() => {
                    avatar.style.transition = '';
                }, 50);
            });

            // ç”Ÿæˆéšæœºé¡ºåº
            const avatarCount = Math.min(avatars.length, 8);
            const randomOrder = [];
            for (let i = 0; i < avatarCount; i++) {
                randomOrder.push(i);
            }

            // Fisher-Yates æ´—ç‰Œç®—æ³•
            for (let i = randomOrder.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [randomOrder[i], randomOrder[j]] = [randomOrder[j], randomOrder[i]];
            }

            addActionLog(`ğŸ¯ æµ‹è¯•å¼•åŠ›åŠ¨ç”»ï¼šéšæœºç”Ÿæˆé¡ºåº [${randomOrder.join(', ')}]`);

            // å»¶è¿Ÿè®¾ç½®å¼•åŠ›ç›®æ ‡ï¼Œç¡®ä¿é‡ç½®å®Œæˆ
            setTimeout(() => {
                // ä¸ºæ¯ä¸ªè§’è‰²è®¾ç½®å¼•åŠ›ç›®æ ‡
                avatars.forEach((avatar, index) => {
                    if (index < avatarCount) {
                        const characterId = avatar.dataset.characterId;
                        const targetIndex = randomOrder[index];

                        // è®¾ç½®å¼•åŠ›ç›®æ ‡
                        setGravityTarget(characterId, targetIndex);
                    }
                });

                // åº”ç”¨å¼•åŠ›åŠ¨ç”»
                applyGravityAnimation();
            }, 100);

            // 3ç§’åæ¢å¤åŸå§‹é¡ºåº
            setTimeout(() => {
                // å¼ºåˆ¶åœæ­¢æ‰€æœ‰åŠ¨ç”»
                isAnimating = false;
                animationQueue.length = 0;
                gravityTargets.clear();

                // ç«‹å³é‡ç½®åˆ°åŸå§‹ä½ç½®
                avatars.forEach((avatar, index) => {
                    if (index < avatarCount) {
                        avatar.style.transition = 'none';
                        avatar.style.top = `${index * 48}px`;
                        avatar.classList.remove('gravity-fast', 'gravity-medium', 'gravity-slow');
                        setTimeout(() => {
                            avatar.style.transition = '';
                        }, 50);
                    }
                });

                addActionLog("ğŸ¯ å¼•åŠ›åŠ¨ç”»æµ‹è¯•å®Œæˆï¼Œæ¢å¤åŸå§‹é¡ºåº");
            }, 3000);
        }

        // é¢„æµ‹æ¼”ç¤ºåŠŸèƒ½
    </script>
</body>
</html>